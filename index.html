<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>æé†’ç®¡ç†å·¥å…·</title>
    <style>
        body {
            font-family: system-ui;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #0a0f1c;
            color: #e2e8f0;
        }
        .card {
            background: #1e293b;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            border: 1px solid #334155;
        }
        input, button {
            padding: 10px 16px;
            border-radius: 8px;
            border: 1px solid #334155;
            background: #0f172a;
            color: white;
            font-size: 14px;
        }
        button {
            background: #3b82f6;
            border: none;
            cursor: pointer;
        }
        .item {
            background: #0f172a;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
        }
    </style>
</head>
<body>
    <div class="card">
        <h1>â° æé†’ç®¡ç†å·¥å…·</h1>
        <p style="color: #94a3b8;">åªè´Ÿè´£ç®¡ç†æ•°æ®ï¼Œæé†’ç”±GitHub Actionsè‡ªåŠ¨å‘é€</p>
    </div>

    <div class="card">
        <h2>ğŸ”§ GitHubé…ç½®</h2>
        <div style="display: grid; gap: 16px; margin-top: 20px;">
            <input type="text" id="username" value="xiaowei1110000-cmyk" placeholder="ç”¨æˆ·å">
            <input type="text" id="repo" value="telegram-reminder" placeholder="ä»“åº“å">
            <input type="password" id="token" placeholder="GitHub Token">
            <div>
                <button onclick="saveConfig()">ä¿å­˜é…ç½®</button>
                <button onclick="loadData()">åŠ è½½æ•°æ®</button>
                <button onclick="saveData()">ä¿å­˜æ•°æ®</button>
            </div>
            <div id="status" style="color: #34d399;"></div>
        </div>
    </div>

    <div class="card">
        <h2>â• æ·»åŠ æé†’</h2>
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 12px;">
            <input type="text" id="name" placeholder="åç§°">
            <input type="date" id="date">
            <input type="number" id="days" value="3" min="1">
            <button onclick="addReminder()">æ·»åŠ </button>
        </div>
    </div>

    <div class="card">
        <h2>ğŸ“‹ æé†’åˆ—è¡¨</h2>
        <div id="list"></div>
    </div>

    <script>
        let reminders = [];
        let config = { username: 'xiaowei1110000-cmyk', repo: 'telegram-reminder', token: '' };

        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date').value = today;
            
            const saved = localStorage.getItem('github_config');
            if (saved) {
                config = JSON.parse(saved);
                document.getElementById('username').value = config.username;
                document.getElementById('repo').value = config.repo;
                document.getElementById('token').value = config.token;
                loadData();
            }
        });

        function saveConfig() {
            config = {
                username: document.getElementById('username').value.trim(),
                repo: document.getElementById('repo').value.trim(),
                token: document.getElementById('token').value.trim()
            };
            localStorage.setItem('github_config', JSON.stringify(config));
            document.getElementById('status').innerHTML = 'âœ… é…ç½®å·²ä¿å­˜';
        }

        async function loadData() {
            if (!config.token) return alert('è¯·å…ˆé…ç½®Token');
            
            try {
                const url = `https://api.github.com/repos/${config.username}/${config.repo}/contents/reminders.json`;
                const res = await fetch(url, {
                    headers: { 'Authorization': `token ${config.token}` }
                });
                
                if (res.status === 404) {
                    reminders = [];
                    renderList();
                    document.getElementById('status').innerHTML = 'â„¹ï¸ æ— æ•°æ®æ–‡ä»¶';
                    return;
                }
                
                const data = await res.json();
                const content = decodeURIComponent(escape(atob(data.content)));
                reminders = JSON.parse(content);
                renderList();
                document.getElementById('status').innerHTML = 'âœ… åŠ è½½æˆåŠŸ';
            } catch (e) {
                document.getElementById('status').innerHTML = 'âŒ åŠ è½½å¤±è´¥: ' + e.message;
            }
        }

        async function saveData() {
            if (!config.token) return alert('è¯·å…ˆé…ç½®Token');
            if (reminders.length === 0) return alert('æ²¡æœ‰æ•°æ®å¯ä¿å­˜');
            
            try {
                const url = `https://api.github.com/repos/${config.username}/${config.repo}/contents/reminders.json`;
                
                // è·å–å½“å‰æ–‡ä»¶ï¼ˆç”¨äºè·å–SHAï¼‰
                let sha = null;
                const getRes = await fetch(url, {
                    headers: { 'Authorization': `token ${config.token}` }
                });
                
                if (getRes.status === 200) {
                    const data = await getRes.json();
                    sha = data.sha;
                }
                
                // æ›´æ–°æ–‡ä»¶
                const content = btoa(unescape(encodeURIComponent(JSON.stringify(reminders, null, 2))));
                const putRes = await fetch(url, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${config.token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: 'æ›´æ–°æé†’æ•°æ®',
                        content: content,
                        sha: sha
                    })
                });
                
                if (putRes.ok) {
                    document.getElementById('status').innerHTML = 'âœ… ä¿å­˜æˆåŠŸ';
                } else {
                    const err = await putRes.json();
                    throw new Error(err.message);
                }
            } catch (e) {
                document.getElementById('status').innerHTML = 'âŒ ä¿å­˜å¤±è´¥: ' + e.message;
            }
        }

        function addReminder() {
            const name = document.getElementById('name').value.trim();
            const lastDate = document.getElementById('date').value;
            const days = parseInt(document.getElementById('days').value);
            
            if (!name || !lastDate || !days) return alert('è¯·å¡«å†™å®Œæ•´');
            
            const nextDate = new Date(lastDate);
            nextDate.setDate(nextDate.getDate() + days);
            
            reminders.push({
                id: Date.now(),
                name: name,
                lastUpdated: lastDate,
                nextReminder: nextDate.toISOString().split('T')[0],
                days: days,
                notified: false
            });
            
            renderList();
            document.getElementById('name').value = '';
        }

        function deleteReminder(id) {
            reminders = reminders.filter(r => r.id !== id);
            renderList();
        }

        function renderList() {
            const today = new Date().toISOString().split('T')[0];
            let html = '';
            
            reminders.forEach(r => {
                const isDue = r.nextReminder === today;
                html += `
                    <div class="item" style="border-left: 4px solid ${isDue ? '#ef4444' : '#3b82f6'}">
                        <div style="display: flex; justify-content: space-between;">
                            <strong>${r.name}</strong>
                            <span style="color: ${isDue ? '#f87171' : '#94a3b8'}">
                                ${isDue ? 'ä»Šæ—¥åˆ°æœŸ' : ''}
                            </span>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; margin-top: 12px;">
                            <div>æœ€åæ›´æ–°: ${r.lastUpdated}</div>
                            <div>ä¸‹æ¬¡æé†’: ${r.nextReminder}</div>
                            <div>é—´éš”: ${r.days}å¤©</div>
                        </div>
                        <button onclick="deleteReminder(${r.id})" style="margin-top: 12px; background: #ef4444;">åˆ é™¤</button>
                    </div>
                `;
            });
            
            document.getElementById('list').innerHTML = html || '<p style="color: #64748b;">æš‚æ— æé†’</p>';
        }
    </script>
</body>
</html>
