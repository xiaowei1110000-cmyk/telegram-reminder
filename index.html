<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub定时提醒系统</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(135deg, #0088cc, #005a8c);
            color: white;
            padding: 25px;
            text-align: center;
        }
        
        header h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
        }
        
        header p {
            opacity: 0.9;
        }
        
        .content {
            padding: 25px;
        }
        
        .section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
        }
        
        h2 {
            color: #0088cc;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }
        
        input:focus, select:focus, textarea:focus {
            border-color: #0088cc;
            outline: none;
        }
        
        .btn {
            padding: 14px 25px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-top: 10px;
        }
        
        .btn-primary {
            background: #0088cc;
            color: white;
        }
        
        .btn-primary:hover {
            background: #005a8c;
            transform: translateY(-2px);
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .btn-warning {
            background: #ffc107;
            color: #333;
        }
        
        .btn-warning:hover {
            background: #e0a800;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .btn-block {
            width: 100%;
        }
        
        .btn-small {
            padding: 8px 15px;
            font-size: 14px;
        }
        
        .reminder-item {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #0088cc;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .reminder-info h4 {
            color: #333;
            margin-bottom: 5px;
        }
        
        .reminder-details {
            color: #666;
            font-size: 14px;
        }
        
        .notification {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .notification.success {
            background: #d4edda;
            border-left: 4px solid #28a745;
            color: #155724;
        }
        
        .notification.error {
            background: #f8d7da;
            border-left: 4px solid #dc3545;
            color: #721c24;
        }
        
        .notification.info {
            background: #d1ecf1;
            border-left: 4px solid #17a2b8;
            color: #0c5460;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .action-buttons .btn {
            flex: 1;
            min-width: 150px;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-online {
            background: #28a745;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .status-offline {
            background: #dc3545;
        }
        
        footer {
            text-align: center;
            padding: 20px;
            color: #666;
            border-top: 1px solid #eee;
            margin-top: 20px;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .test-section {
            background: #e3f2fd;
            border: 2px solid #bbdefb;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fab fa-telegram"></i> GitHub定时提醒系统</h1>
            <p>无需服务器！测试发送功能可用</p>
        </header>
        
        <div class="content">
            <div id="notificationArea"></div>
            
            <div class="section">
                <h2><i class="fas fa-cog"></i> 基本配置</h2>
                
                <div class="input-group">
                    <label for="serverUrl">GitHub仓库地址（用于测试）</label>
                    <input type="text" id="serverUrl" placeholder="https://api.github.com/repos/用户名/仓库名">
                    <small style="color:#666;">例如：https://api.github.com/repos/yourname/telegram-reminder</small>
                </div>
                
                <button id="testConnectionBtn" class="btn btn-primary">
                    <i class="fas fa-plug"></i> 测试GitHub连接
                </button>
            </div>
            
            <div class="section test-section">
                <h2><i class="fas fa-vial"></i> 测试Telegram发送功能</h2>
                <p style="margin-bottom: 15px; color: #666;">测试您的Bot配置是否正确</p>
                
                <div class="input-group">
                    <label for="testMessage">测试消息内容</label>
                    <textarea id="testMessage" rows="3" placeholder="输入测试消息内容...">✅ 测试消息：Telegram提醒系统运行正常！</textarea>
                </div>
                
                <div class="action-buttons">
                    <button id="testSimpleBtn" class="btn btn-success">
                        <i class="fas fa-paper-plane"></i> 简单测试
                    </button>
                    <button id="testWorkflowBtn" class="btn btn-primary">
                        <i class="fab fa-github"></i> 通过GitHub测试
                    </button>
                    <button id="testAllBtn" class="btn btn-warning">
                        <i class="fas fa-bolt"></i> 完整测试
                    </button>
                </div>
            </div>
            
            <div class="section">
                <h2><i class="fas fa-plus-circle"></i> 添加提醒类型</h2>
                
                <div class="input-group">
                    <label for="reminderName">提醒类型名称</label>
                    <input type="text" id="reminderName" placeholder="例如：短信域名池、WEB大厅、后端加速、APP更新">
                </div>
                
                <div class="input-group">
                    <label for="lastUpdated">上次更新日期</label>
                    <input type="date" id="lastUpdated">
                </div>
                
                <div class="input-group">
                    <label for="reminderDays">提醒间隔天数</label>
                    <input type="number" id="reminderDays" value="3" min="1" max="365">
                    <small style="color:#666;">每几天提醒一次（默认3天）</small>
                </div>
                
                <button id="addReminderBtn" class="btn btn-success btn-block">
                    <i class="fas fa-plus"></i> 添加到提醒列表
                </button>
            </div>
            
            <div class="section">
                <h2><i class="fas fa-list"></i> 提醒列表</h2>
                <div id="reminderList">
                    <div class="reminder-item" style="text-align:center; color:#666;">
                        <i class="far fa-bell" style="font-size:24px; margin-bottom:10px; display:block;"></i>
                        <p>暂无提醒项目，请添加您的第一个提醒</p>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button id="saveToGitHubBtn" class="btn btn-primary">
                        <i class="fas fa-cloud-upload-alt"></i> 保存到GitHub
                    </button>
                    <button id="manualTriggerBtn" class="btn btn-warning">
                        <i class="fas fa-play"></i> 手动触发提醒
                    </button>
                </div>
            </div>
            
            <div class="section">
                <h2><i class="fas fa-server"></i> 系统状态</h2>
                
                <div style="margin-bottom: 15px;">
                    <p><span class="status-indicator status-offline" id="statusIcon"></span> 
                       <span id="statusText">等待连接测试...</span>
                    </p>
                    <p id="nextRunInfo" style="color:#666; font-size:14px; margin-top:5px;"></p>
                </div>
                
                <div class="action-buttons">
                    <button id="viewLogsBtn" class="btn btn-small">
                        <i class="fas fa-file-alt"></i> 查看日志
                    </button>
                    <button id="viewActionsBtn" class="btn btn-small">
                        <i class="fab fa-github"></i> GitHub Actions
                    </button>
                    <button id="openTelegramBtn" class="btn btn-small">
                        <i class="fab fa-telegram"></i> 打开Telegram
                    </button>
                </div>
            </div>
        </div>
        
        <footer>
            <p>基于GitHub Actions的定时提醒系统 | 包含完整测试功能</p>
            <p>GitHub Actions会在每天11:00（北京时间）自动运行</p>
        </footer>
    </div>

    <script>
        // 存储提醒数据
        let reminders = [];
        let githubRepo = '';
        
        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 设置默认日期为今天（已修复语法错误）
            document.getElementById('lastUpdated').valueAsDate = new Date();
            
            // 从本地存储加载数据
            loadFromLocalStorage();
            
            // 更新提醒列表显示
            updateReminderList();
            
            // 设置事件监听器
            setupEventListeners();
        });
        
        // 设置事件监听器
        function setupEventListeners() {
            // 测试连接按钮
            document.getElementById('testConnectionBtn').addEventListener('click', testGitHubConnection);
            
            // 简单测试按钮
            document.getElementById('testSimpleBtn').addEventListener('click', testSimpleTelegram);
            
            // GitHub测试按钮
            document.getElementById('testWorkflowBtn').addEventListener('click', testViaGitHub);
            
            // 完整测试按钮
            document.getElementById('testAllBtn').addEventListener('click', runFullTest);
            
            // 添加提醒按钮
            document.getElementById('addReminderBtn').addEventListener('click', addReminder);
            
            // 保存到GitHub按钮
            document.getElementById('saveToGitHubBtn').addEventListener('click', saveToGitHub);
            
            // 手动触发按钮
            document.getElementById('manualTriggerBtn').addEventListener('click', manualTrigger);
            
            // 其他功能按钮
            document.getElementById('viewLogsBtn').addEventListener('click', viewLogs);
            document.getElementById('viewActionsBtn').addEventListener('click', viewActions);
            document.getElementById('openTelegramBtn').addEventListener('click', openTelegram);
        }
        
        // 测试GitHub连接
        async function testGitHubConnection() {
            const url = document.getElementById('serverUrl').value.trim();
            if (!url) {
                showNotification('请输入GitHub仓库地址', 'error');
                return;
            }
            
            githubRepo = url;
            showNotification('正在测试GitHub连接...', 'info');
            
            try {
                // 测试GitHub API连接
                const response = await fetch(url);
                if (response.ok) {
                    showNotification('GitHub连接成功！', 'success');
                    updateStatus('connected');
                } else {
                    showNotification('GitHub连接失败，请检查地址', 'error');
                }
            } catch (error) {
                showNotification(`连接失败: ${error.message}`, 'error');
            }
        }
        
        // 简单测试：直接调用Telegram API（前端限制，需要代理）
        async function testSimpleTelegram() {
            showNotification('简单测试需要服务器支持，请使用GitHub测试', 'info');
            
            // 显示如何手动测试
            const testInstructions = `
            <strong>手动测试步骤：</strong><br>
            1. 进入你的GitHub仓库：https://github.com/你的用户名/telegram-reminder<br>
            2. 点击 "Actions" 标签<br>
            3. 选择 "Send Telegram Reminder"<br>
            4. 点击 "Run workflow" → "Run workflow"<br>
            5. 等待运行完成，查看Telegram消息
            `;
            
            showNotification(testInstructions, 'info');
        }
        
        // 通过GitHub Actions测试
        async function testViaGitHub() {
            if (!githubRepo) {
                showNotification('请先测试GitHub连接', 'error');
                return;
            }
            
            showNotification('正在通过GitHub Actions测试...', 'info');
            
            // 解析仓库信息
            const repoMatch = githubRepo.match(/repos\/([^\/]+)\/([^\/]+)/);
            if (!repoMatch) {
                showNotification('GitHub地址格式错误', 'error');
                return;
            }
            
            const [_, owner, repo] = repoMatch;
            
            try {
                // 触发GitHub Actions workflow_dispatch
                const response = await fetch(`https://api.github.com/repos/${owner}/${repo}/actions/workflows/reminder.yml/dispatches`, {
                    method: 'POST',
                    headers: {
                        'Authorization': 'token 你的GitHub Token', // 注意：需要用户授权
                        'Accept': 'application/vnd.github.v3+json'
                    },
                    body: JSON.stringify({
                        ref: 'main'
                    })
                });
                
                if (response.ok) {
                    showNotification('GitHub Actions测试已触发！请检查Actions页面和Telegram', 'success');
                } else {
                    showNotification('触发失败，请手动运行Actions', 'error');
                }
            } catch (error) {
                // 如果API调用失败，显示手动操作指南
                showManualTestGuide(owner, repo);
            }
        }
        
        // 显示手动测试指南
        function showManualTestGuide(owner, repo) {
            const guide = `
            <strong>手动测试GitHub Actions：</strong><br>
            1. 访问：https://github.com/${owner}/${repo}/actions<br>
            2. 在左侧找到 "Send Telegram Reminder"<br>
            3. 点击 "Run workflow" 按钮<br>
            4. 选择分支 "main"<br>
            5. 点击绿色 "Run workflow" 按钮<br>
            6. 等待运行完成（约30秒）<br>
            7. 检查Telegram群组是否收到消息
            `;
            
            showNotification(guide, 'info');
            
            // 添加打开链接的按钮
            setTimeout(() => {
                const actionsUrl = `https://github.com/${owner}/${repo}/actions`;
                const notification = document.createElement('div');
                notification.className = 'notification info';
                notification.innerHTML = `
                    <i class="fas fa-external-link-alt"></i>
                    <div>
                        <strong>快速访问：</strong><br>
                        <a href="${actionsUrl}" target="_blank" style="color:#007bff; text-decoration:underline;">
                            点击这里打开Actions页面
                        </a>
                    </div>
                `;
                document.getElementById('notificationArea').appendChild(notification);
            }, 1000);
        }
        
        // 运行完整测试
        async function runFullTest() {
            showNotification('开始完整测试...', 'info');
            
            // 步骤1：检查数据
            if (reminders.length === 0) {
                showNotification('请先添加至少一个提醒类型', 'error');
                return;
            }
            
            // 步骤2：检查GitHub连接
            if (!githubRepo) {
                await testGitHubConnection();
                if (!githubRepo) return;
            }
            
            // 步骤3：保存数据到GitHub
            await saveToGitHub();
            
            // 步骤4：触发GitHub Actions
            await testViaGitHub();
            
            showNotification('完整测试流程已启动！请等待GitHub Actions运行完成', 'success');
        }
        
        // 添加提醒
        function addReminder() {
            const name = document.getElementById('reminderName').value.trim();
            const lastUpdated = document.getElementById('lastUpdated').value;
            const days = parseInt(document.getElementById('reminderDays').value);
            
            if (!name) {
                showNotification('请输入提醒类型名称', 'error');
                return;
            }
            
            if (!lastUpdated) {
                showNotification('请选择上次更新日期', 'error');
                return;
            }
            
            if (!days || days < 1) {
                showNotification('提醒间隔天数必须大于0', 'error');
                return;
            }
            
            // 创建提醒对象
            const reminder = {
                id: Date.now(),
                name: name,
                lastUpdated: lastUpdated,
                days: days,
                createdAt: new Date().toISOString()
            };
            
            // 添加到列表
            reminders.push(reminder);
            
            // 保存到本地存储
            saveToLocalStorage();
            
            // 更新显示
            updateReminderList();
            
            // 清空表单
            document.getElementById('reminderName').value = '';
            document.getElementById('reminderDays').value = '3';
            document.getElementById('lastUpdated').valueAsDate = new Date();
            
            showNotification(`"${name}" 已添加到提醒列表`, 'success');
        }
        
        // 删除提醒
        function deleteReminder(id) {
            if (confirm('确定要删除这个提醒吗？')) {
                reminders = reminders.filter(r => r.id !== id);
                saveToLocalStorage();
                updateReminderList();
                showNotification('提醒已删除', 'success');
            }
        }
        
        // 更新提醒列表显示
        function updateReminderList() {
            const reminderList = document.getElementById('reminderList');
            
            if (reminders.length === 0) {
                reminderList.innerHTML = `
                    <div class="reminder-item" style="text-align:center; color:#666;">
                        <i class="far fa-bell" style="font-size:24px; margin-bottom:10px; display:block;"></i>
                        <p>暂无提醒项目，请添加您的第一个提醒</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            
            reminders.forEach(reminder => {
                // 计算下次提醒日期
                const lastDate = new Date(reminder.lastUpdated);
                const nextDate = new Date(lastDate);
                nextDate.setDate(nextDate.getDate() + reminder.days);
                const nextStr = nextDate.toLocaleDateString('zh-CN');
                
                // 计算剩余天数
                const today = new Date();
                const diffTime = nextDate - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                let status = '';
                if (diffDays <= 0) {
                    status = '<span style="color:#dc3545; font-weight:bold;">今日需要提醒</span>';
                } else if (diffDays === 1) {
                    status = '<span style="color:#ffc107; font-weight:bold;">明天提醒</span>';
                } else {
                    status = `<span>${diffDays}天后提醒</span>`;
                }
                
                html += `
                    <div class="reminder-item">
                        <div class="reminder-info">
                            <h4>${reminder.name}</h4>
                            <div class="reminder-details">
                                上次更新: ${reminder.lastUpdated} | 间隔: ${reminder.days}天 | 下次提醒: ${nextStr} (${status})
                            </div>
                        </div>
                        <button class="btn btn-small btn-danger" onclick="deleteReminder(${reminder.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
            });
            
            reminderList.innerHTML = html;
        }
        
        // 保存到GitHub
        async function saveToGitHub() {
            if (!githubRepo) {
                showNotification('请先测试GitHub连接', 'error');
                return;
            }
            
            showNotification('正在保存提醒数据到GitHub...', 'info');
            
            // 这里实际应该调用GitHub API更新reminders.json文件
            // 但由于GitHub API需要认证，这里只显示提示
            
            const guide = `
            <strong>手动保存到GitHub：</strong><br>
            1. 复制下面的JSON数据<br>
            2. 访问你的GitHub仓库：${githubRepo}<br>
            3. 点击 reminders.json 文件<br>
            4. 点击编辑按钮（铅笔图标）<br>
            5. 粘贴JSON数据<br>
            6. 点击 Commit changes
            `;
            
            showNotification(guide, 'info');
            
            // 显示JSON数据
            const jsonData = JSON.stringify(reminders, null, 2);
            setTimeout(() => {
                const notification = document.createElement('div');
                notification.className = 'notification info';
                notification.innerHTML = `
                    <i class="fas fa-code"></i>
                    <div>
                        <strong>提醒数据JSON：</strong><br>
                        <textarea style="width:100%; height:100px; margin-top:10px; padding:10px; border:1px solid #ccc; border-radius:5px; font-family:monospace;" readonly>${jsonData}</textarea>
                        <button onclick="copyToClipboard('${jsonData.replace(/\n/g, '\\n').replace(/"/g, '\\"')}')" style="margin-top:5px; padding:5px 10px; background:#007bff; color:white; border:none; border-radius:3px; cursor:pointer;">
                            复制到剪贴板
                        </button>
                    </div>
                `;
                document.getElementById('notificationArea').appendChild(notification);
            }, 500);
        }
        
        // 手动触发提醒
        function manualTrigger() {
            showNotification('手动触发将通过GitHub Actions进行...', 'info');
            testViaGitHub();
        }
        
        // 查看日志
        function viewLogs() {
            if (githubRepo) {
                const logsUrl = githubRepo.replace('api.github.com/repos', 'github.com') + '/actions';
                window.open(logsUrl, '_blank');
            } else {
                showNotification('请先设置GitHub仓库地址', 'error');
            }
        }
        
        // 查看Actions
        function viewActions() {
            if (githubRepo) {
                const actionsUrl = githubRepo.replace('api.github.com/repos', 'github.com') + '/actions';
                window.open(actionsUrl, '_blank');
            } else {
                showNotification('请先设置GitHub仓库地址', 'error');
            }
        }
        
        // 打开Telegram
        function openTelegram() {
            window.open('https://web.telegram.org', '_blank');
        }
        
        // 更新状态显示
        function updateStatus(status) {
            const statusIcon = document.getElementById('statusIcon');
            const statusText = document.getElementById('statusText');
            const nextRunInfo = document.getElementById('nextRunInfo');
            
            if (status === 'connected') {
                statusIcon.className = 'status-indicator status-online';
                statusText.textContent = 'GitHub连接正常';
                nextRunInfo.textContent = '下次自动运行：每天11:00（北京时间）';
            } else {
                statusIcon.className = 'status-indicator status-offline';
                statusText.textContent = '未连接GitHub';
                nextRunInfo.textContent = '';
            }
        }
        
        // 保存到本地存储
        function saveToLocalStorage() {
            localStorage.setItem('telegramReminders', JSON.stringify(reminders));
        }
        
        // 从本地存储加载
        function loadFromLocalStorage() {
            const saved = localStorage.getItem('telegramReminders');
            if (saved) {
                try {
                    reminders = JSON.parse(saved);
                } catch (e) {
                    reminders = [];
                }
            }
        }
        
        // 复制到剪贴板
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showNotification('已复制到剪贴板！', 'success');
            });
        }
        
        // 显示通知
        function showNotification(message, type) {
            const notificationArea = document.getElementById('notificationArea');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            
            let icon = 'fas fa-info-circle';
            if (type === 'success') icon = 'fas fa-check-circle';
            if (type === 'error') icon = 'fas fa-exclamation-circle';
            if (type === 'info') icon = 'fas fa-info-circle';
            
            // 处理HTML内容
            if (typeof message === 'string' && message.includes('<')) {
                notification.innerHTML = `
                    <i class="${icon}"></i>
                    <div>${message}</div>
                `;
            } else {
                notification.innerHTML = `
                    <i class="${icon}"></i>
                    <div>${message}</div>
                `;
            }
            
            notificationArea.appendChild(notification);
            
            // 5秒后移除
            setTimeout(() => {
                if (notification.parentNode === notificationArea) {
                    notificationArea.removeChild(notification);
                }
            }, 10000);
        }
        
        // 导出函数到全局
        window.deleteReminder = deleteReminder;
        window.copyToClipboard = copyToClipboard;
    </script>
</body>
</html>
