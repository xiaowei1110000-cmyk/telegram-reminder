name: å®šæ—¶æé†’ç³»ç»Ÿ

on:
  schedule:
    - cron: '0 3 * * *'   # UTC 3:00 = åŒ—äº¬æ—¶é—´ 11:00
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'reminders.json'
  repository_dispatch:
    types: [ping, check-reminders]

jobs:
  reminder:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v3
          
      - name: â° è®¾ç½®åŒ—äº¬æ—¶é—´
        run: |
          sudo timedatectl set-timezone Asia/Shanghai
          echo "TODAY=$(date '+%Y-%m-%d')" >> $GITHUB_ENV
          echo "CURRENT_TIME=$(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_ENV
          
      - name: ğŸ¤– æé†’ç³»ç»Ÿï¼ˆä¿®å¤ç‰ˆï¼‰
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          echo "========================================="
          echo "ğŸš€ å®šæ—¶æé†’ç³»ç»Ÿ Â· ä¿®å¤ç‰ˆ"
          echo "â° åŒ—äº¬æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "========================================="
          
          # å®‰è£… jq
          sudo apt-get update -qq && sudo apt-get install -y jq -qq
          
          TODAY="${{ env.TODAY }}"
          echo "ğŸ“… ä»Šå¤©æ—¥æœŸ: $TODAY"
          
          # æ£€æŸ¥æ–‡ä»¶
          if [ ! -f "reminders.json" ]; then
            echo "[]" > reminders.json
            echo "ğŸ“ å·²åˆ›å»ºç©ºçš„ reminders.json"
            git add reminders.json
            git commit -m "åˆå§‹åŒ– reminders.json" || true
            git push || true
          fi
          
          # è¯»å–æ‰€æœ‰æé†’
          COUNT=$(jq '. | length' reminders.json)
          echo "ğŸ“‹ å…±æœ‰ $COUNT ä¸ªæé†’é¡¹ç›®"
          
          # æ£€æŸ¥ä»Šå¤©åˆ°æœŸçš„é¡¹ç›®
          DUE_ITEMS=""
          SENT=0
          NEED_COMMIT=false
          
          # ä¸´æ—¶æ–‡ä»¶
          TMP_FILE=$(mktemp)
          cp reminders.json $TMP_FILE
          
          for i in $(seq 0 $((COUNT-1))); do
            NAME=$(jq -r ".[$i].name" reminders.json)
            NEXT=$(jq -r ".[$i].nextReminder" reminders.json)
            DAYS=$(jq -r ".[$i].days" reminders.json)
            LAST=$(jq -r ".[$i].lastUpdated // \"æœªçŸ¥\"" reminders.json)
            
            # æ£€æŸ¥æ˜¯å¦æ˜¯ä»Šå¤©åˆ°æœŸ
            if [ "$NEXT" == "$TODAY" ]; then
              echo ""
              echo "âš ï¸ å‘ç°åˆ°æœŸé¡¹ç›®: $NAME"
              
              # æ·»åŠ åˆ°åˆ°æœŸåˆ—è¡¨
              DUE_ITEMS="${DUE_ITEMS}â€¢ <b>${NAME}</b> (å‘¨æœŸ: ${DAYS}å¤©)\n"
              
              # è®¡ç®—ä¸‹æ¬¡æé†’æ—¥æœŸ
              NEXT_DATE=$(date -d "$TODAY + $DAYS days" '+%Y-%m-%d')
              
              # æ„å»ºæ¶ˆæ¯
              MESSAGE="ğŸ”” <b>åˆ°æœŸæé†’</b>%0A%0A"
              MESSAGE="${MESSAGE}ğŸ“Œ é¡¹ç›®: ${NAME}%0A"
              MESSAGE="${MESSAGE}â”œâ”€ ä¸Šæ¬¡æ›´æ–°: ${LAST}%0A"
              MESSAGE="${MESSAGE}â”œâ”€ æœ¬æ¬¡æé†’: ä»Šå¤© ${TODAY}%0A"
              MESSAGE="${MESSAGE}â”œâ”€ é—´éš”å‘¨æœŸ: ${DAYS} å¤©%0A"
              MESSAGE="${MESSAGE}â””â”€ ä¸‹æ¬¡æé†’: ${NEXT_DATE}%0A%0A"
              MESSAGE="${MESSAGE}âš¡ï¸ è¯·åŠæ—¶å¤„ç†"
              
              echo "ğŸ“¤ æ­£åœ¨å‘é€ Telegram æé†’..."
              
              # å‘é€ Telegram
              RESPONSE=$(curl -s -X POST \
                "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
                -d "chat_id=${TELEGRAM_CHAT_ID}" \
                -d "text=${MESSAGE}" \
                -d "parse_mode=HTML")
              
              if echo "$RESPONSE" | grep -q '"ok":true'; then
                echo "âœ… å‘é€æˆåŠŸ"
                SENT=$((SENT+1))
                
                # æ›´æ–° JSON
                jq ".[$i].lastUpdated = \"$TODAY\"" $TMP_FILE > tmp2.json && mv tmp2.json $TMP_FILE
                jq ".[$i].nextReminder = \"$NEXT_DATE\"" $TMP_FILE > tmp2.json && mv tmp2.json $TMP_FILE
                jq ".[$i].notified = true" $TMP_FILE > tmp2.json && mv tmp2.json $TMP_FILE
                jq ".[$i].lastSentTime = \"$(date -Iseconds)\"" $TMP_FILE > tmp2.json && mv tmp2.json $TMP_FILE
                
                NEED_COMMIT=true
              else
                echo "âŒ å‘é€å¤±è´¥: $RESPONSE"
              fi
            fi
          done
          
          # å¦‚æœæœ‰å‘é€æˆåŠŸï¼Œæ›´æ–°åŸæ–‡ä»¶
          if [ "$NEED_COMMIT" == "true" ]; then
            mv $TMP_FILE reminders.json
            
            echo ""
            echo "ğŸ“Š æœ¬æ¬¡è¿è¡Œ: å‘é€ $SENT æ¡æé†’"
            
            # æäº¤åˆ° GitHub
            git config --global user.name "Reminder Bot"
            git config --global user.email "reminder-bot@users.noreply.github.com"
            
            git add reminders.json
            git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–°æé†’æ—¥æœŸ [$(date '+%Y-%m-%d %H:%M:%S')]" || true
            git push
            
            echo "âœ… GitHub æ›´æ–°æˆåŠŸ"
          else
            echo ""
            echo "â„¹ï¸ ä»Šå¤©æ²¡æœ‰åˆ°æœŸé¡¹ç›®"
            rm -f $TMP_FILE
          fi
          
          echo ""
          echo "========================================="
          echo "âœ… æ‰§è¡Œå®Œæˆ"
          echo "========================================="
