name: å®šæ—¶æé†’

on:
  schedule:
    - cron: '*/3 * * * *'
  workflow_dispatch:

jobs:
  send:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v3
      
      - name: å‘é€æé†’
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          echo "å¼€å§‹æ‰§è¡Œæé†’æ£€æŸ¥..."
          echo "å½“å‰æ—¶é—´: $(date)"
          
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ ! -f "reminders.json" ]; then
            echo "é”™è¯¯: reminders.json ä¸å­˜åœ¨ï¼"
            exit 1
          fi
          
          # å®‰è£…jq
          sudo apt-get update && sudo apt-get install -y jq
          
          # è·å–ä»Šå¤©æ—¥æœŸ
          TODAY=$(date '+%Y-%m-%d')
          echo "ä»Šå¤©æ—¥æœŸ: $TODAY"
          
          # è¯»å–æé†’å¹¶æ£€æŸ¥
          jq -c '.[]' reminders.json | while read item; do
            NAME=$(echo $item | jq -r '.name')
            NEXT=$(echo $item | jq -r '.nextReminder')
            DAYS=$(echo $item | jq -r '.days')
            
            echo "æ£€æŸ¥: $NAME, ä¸‹æ¬¡æé†’: $NEXT"
            
            if [ "$NEXT" == "$TODAY" ]; then
              echo "âš ï¸ ä»Šæ—¥åˆ°æœŸï¼Œå‘é€æé†’..."
              
              # å‘é€Telegramæ¶ˆæ¯
              curl -s -X POST \
                "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
                -d "chat_id=${CHAT_ID}" \
                -d "text=ğŸ”” æé†’: ${NAME}%0AğŸ“… æ—¥æœŸ: ${TODAY}%0Aâ° é—´éš”: ${DAYS}å¤©" \
                -d "parse_mode=HTML"
              
              if [ $? -eq 0 ]; then
                echo "âœ… å‘é€æˆåŠŸ"
              else
                echo "âŒ å‘é€å¤±è´¥"
              fi
            fi
          done
          
          echo "æ‰§è¡Œå®Œæˆ"
