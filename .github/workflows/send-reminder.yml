name: å®šæ—¶æé†’ç³»ç»Ÿ

on:
  schedule:
    - cron: '*/3 * * * *'   # æ¯3åˆ†é’Ÿè¿è¡Œä¸€æ¬¡
  workflow_dispatch:         # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  check-and-send:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v3
        with:
          fetch-depth: 1
          
      - name: ğŸ” æ£€æŸ¥å¹¶å‘é€æé†’
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          echo "========================================="
          echo "â° å®šæ—¶æé†’ç³»ç»Ÿå¼€å§‹æ‰§è¡Œ"
          echo "ğŸ“… æ—¶é—´: $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')"
          echo "ğŸ¯ è§¦å‘æ–¹å¼: ${{ github.event_name }}"
          echo "========================================="
          
          # ========== 1. è¯»å–æé†’æ•°æ® ==========
          if [ ! -f "reminders.json" ]; then
            echo "âŒ reminders.json æ–‡ä»¶ä¸å­˜åœ¨"
            echo "ğŸ“ è¯·å…ˆåœ¨ç½‘é¡µç«¯æ·»åŠ æé†’å¹¶ä¿å­˜åˆ°GitHub"
            exit 0
          fi
          
          echo "ğŸ“– è¯»å–æé†’æ•°æ®..."
          cat reminders.json
          echo ""
          
          # ========== 2. è·å–ä»Šå¤©æ—¥æœŸ ==========
          TODAY=$(TZ='Asia/Shanghai' date '+%Y-%m-%d')
          echo "ğŸ“† ä»Šå¤©æ—¥æœŸ: $TODAY"
          echo ""
          
          # ========== 3. è§£æJSONå¹¶å‘é€æé†’ ==========
          # å®‰è£…jqç”¨äºè§£æJSON
          sudo apt-get update -qq && sudo apt-get install -y jq -qq
          
          # è¯»å–æ‰€æœ‰æé†’
          REMINDER_COUNT=$(jq '. | length' reminders.json)
          echo "ğŸ“‹ å…±æœ‰ $REMINDER_COUNT ä¸ªæé†’"
          
          SENT_COUNT=0
          NEED_UPDATE=false
          
          # å¾ªç¯å¤„ç†æ¯ä¸ªæé†’
          for ((i=0; i<$REMINDER_COUNT; i++)); do
            NAME=$(jq -r ".[$i].name" reminders.json)
            NEXT=$(jq -r ".[$i].nextReminder" reminders.json)
            DAYS=$(jq -r ".[$i].days" reminders.json)
            ENABLED=$(jq -r ".[$i].enabled // true" reminders.json)
            NOTIFIED=$(jq -r ".[$i].notified // false" reminders.json)
            
            if [ "$ENABLED" != "true" ]; then
              echo "â¸ï¸ è·³è¿‡å·²ç¦ç”¨çš„æé†’: $NAME"
              continue
            fi
            
            echo "------------------------"
            echo "ğŸ“Œ æ£€æŸ¥: $NAME"
            echo "ğŸ“… ä¸‹æ¬¡æé†’: $NEXT"
            echo "â° é—´éš”: $DAYSå¤©"
            
            # æ£€æŸ¥æ˜¯å¦ä»Šå¤©åˆ°æœŸ
            if [ "$NEXT" == "$TODAY" ]; then
              if [ "$NOTIFIED" == "false" ]; then
                echo "âš ï¸ ä»Šæ—¥åˆ°æœŸï¼å‘é€æé†’..."
                
                # å‘é€Telegramæ¶ˆæ¯
                MESSAGE="ğŸ”” <b>å®šæ—¶æé†’</b>%0A%0AğŸ“Œ <b>åç§°ï¼š</b>${NAME}%0AğŸ“… <b>æé†’æ—¥æœŸï¼š</b>${NEXT}%0Aâ° <b>é—´éš”ï¼š</b>${DAYS}å¤©%0A%0Aè¯·åŠæ—¶å¤„ç†ï¼"
                
                curl -s -X POST \
                  "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
                  -d "chat_id=${TELEGRAM_CHAT_ID}" \
                  -d "text=${MESSAGE}" \
                  -d "parse_mode=HTML"
                
                if [ $? -eq 0 ]; then
                  echo "âœ… æé†’å‘é€æˆåŠŸ"
                  SENT_COUNT=$((SENT_COUNT+1))
                  NEED_UPDATE=true
                  
                  # æ ‡è®°ä¸ºå·²é€šçŸ¥ï¼ˆåé¢ä¼šæ›´æ–°æ–‡ä»¶ï¼‰
                  # è¿™é‡Œä¸ç›´æ¥ä¿®æ”¹æ–‡ä»¶ï¼Œè€Œæ˜¯ç”¨ä¸´æ—¶æ–‡ä»¶
                else
                  echo "âŒ æé†’å‘é€å¤±è´¥"
                fi
              else
                echo "â¹ï¸ ä»Šå¤©å·²å‘é€è¿‡æé†’ï¼Œä¸å†é‡å¤å‘é€"
              fi
            else
              echo "âœ… æœªåˆ°æœŸ"
            fi
          done
          
          echo "------------------------"
          echo "ğŸ“Š æœ¬æ¬¡å…±å‘é€ $SENT_COUNT æ¡æé†’"
          
          # ========== 4. æ›´æ–°å·²å‘é€æé†’çš„ä¸‹æ¬¡æ—¥æœŸ ==========
          if [ "$NEED_UPDATE" == "true" ]; then
            echo ""
            echo "ğŸ”„ æ›´æ–°å·²å‘é€æé†’çš„ä¸‹æ¬¡æ—¥æœŸ..."
            
            # ä½¿ç”¨Pythonæ›´æ–°æ›´å¯é 
            python3 -c "
import json
from datetime import datetime, timedelta

try:
    with open('reminders.json', 'r', encoding='utf-8') as f:
        data = json.load(f)
    
    today = datetime.now().strftime('%Y-%m-%d')
    updated = 0
    
    for item in data:
        if item.get('nextReminder') == today and item.get('notified') == False:
            # æ›´æ–°æœ€åæ›´æ–°æ—¥æœŸ
            item['lastUpdated'] = today
            # è®¡ç®—ä¸‹æ¬¡æé†’æ—¥æœŸ
            next_date = datetime.now() + timedelta(days=int(item['days']))
            item['nextReminder'] = next_date.strftime('%Y-%m-%d')
            item['notified'] = True
            item['lastSentTime'] = datetime.now().isoformat()
            updated += 1
            print(f'  âœ… å·²æ›´æ–°: {item[\"name\"]} -> {item[\"nextReminder\"]}')
    
    if updated > 0:
        with open('reminders.json', 'w', encoding='utf-8') as f:
            json.dump(data, f, ensure_ascii=False, indent=2)
        print(f'ğŸ“ æˆåŠŸæ›´æ–° {updated} ä¸ªæé†’')
    else:
        print('â„¹ï¸ æ²¡æœ‰éœ€è¦æ›´æ–°çš„æé†’')
        
except Exception as e:
    print(f'âŒ æ›´æ–°å¤±è´¥: {e}')
    exit(1)
"
            
            # ========== 5. æäº¤æ›´æ”¹å›GitHub ==========
            echo ""
            echo "ğŸ“¤ æäº¤æ›´æ–°åˆ°GitHub..."
            
            git config --global user.name "Reminder Bot"
            git config --global user.email "bot@reminder.system"
            
            git add reminders.json
            git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–°æé†’æ—¶é—´ [$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M')]"
            git push
            
            echo "âœ… GitHubæ›´æ–°å®Œæˆ"
          else
            echo "â„¹ï¸ æ— éœ€æ›´æ–°æé†’æ•°æ®"
          fi
          
          echo ""
          echo "========================================="
          echo "âœ… æ‰§è¡Œå®Œæˆ"
          echo "========================================="
