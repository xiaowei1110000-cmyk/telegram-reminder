# ============================================
# GitHubå®šæ—¶æé†’ç³»ç»Ÿ - è‡ªåŠ¨åŒ–å·¥ä½œæµ
# åŠŸèƒ½ï¼šæ¯å¤©11:00è‡ªåŠ¨æ£€æŸ¥å¹¶å‘é€Telegramæé†’
# æ–‡ä»¶ä½ç½®ï¼š.github/workflows/send-reminder.yml
# ============================================

name: ğŸ¤– å®šæ—¶Telegramæé†’

# è§¦å‘æ¡ä»¶
on:
  # 1. å®šæ—¶è§¦å‘ - æ¯å¤©åŒ—äº¬æ—¶é—´11:00
  schedule:
    - cron: '0 3 * * *'     # UTCæ—¶é—´03:00 = åŒ—äº¬æ—¶é—´11:00
  
  # 2. æ‰‹åŠ¨è§¦å‘ - ç”¨äºæµ‹è¯•
  workflow_dispatch:
    inputs:
      reason:
        description: 'æ‰‹åŠ¨è§¦å‘åŸå› '
        required: false
        default: 'æ‰‹åŠ¨æµ‹è¯•è¿è¡Œ'
      environment:
        description: 'è¿è¡Œç¯å¢ƒ'
        required: false
        default: 'production'

# æƒé™è®¾ç½®
permissions:
  contents: write          # å…è®¸å†™å…¥ä»“åº“ï¼ˆæ›´æ–°reminders.jsonï¼‰
  actions: read           # å…è®¸è¯»å–actionsä¿¡æ¯
  issues: read           # å…è®¸è¯»å–issuesï¼ˆå¤‡ç”¨ï¼‰

# ç¯å¢ƒå˜é‡
env:
  TZ: Asia/Shanghai      # è®¾ç½®æ—¶åŒºä¸ºåŒ—äº¬æ—¶é—´
  NODE_VERSION: '18'     # Node.jsç‰ˆæœ¬

# å·¥ä½œä»»åŠ¡
jobs:
  send-telegram-reminder:
    name: ğŸ“¨ å‘é€æé†’
    runs-on: ubuntu-latest
    
    # æ­¥éª¤å®šä¹‰
    steps:
      # æ­¥éª¤1ï¼šæ£€å‡ºä»£ç 
      - name: ğŸ“¥ 1. æ£€å‡ºä»“åº“ä»£ç 
        uses: actions/checkout@v3
        with:
          fetch-depth: 0          # è·å–å®Œæ•´å†å²
          token: ${{ secrets.GITHUB_TOKEN }}
      
      # æ­¥éª¤2ï¼šè®¾ç½®Node.js
      - name: ğŸ”§ 2. é…ç½®Node.jsç¯å¢ƒ
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'           # ç¼“å­˜node_modules
      
      # æ­¥éª¤3ï¼šå®‰è£…ä¾èµ–
      - name: ğŸ“¦ 3. å®‰è£…é¡¹ç›®ä¾èµ–
        run: |
          echo "â³ æ­£åœ¨å®‰è£…node-fetch..."
          npm install node-fetch@2
          echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"
      
      # æ­¥éª¤4ï¼šæ£€æŸ¥å½“å‰çŠ¶æ€
      - name: ğŸ” 4. æ£€æŸ¥ç³»ç»ŸçŠ¶æ€
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ¤– GitHub Actions å®šæ—¶ä»»åŠ¡å·²å¯åŠ¨"
          echo "ğŸ“… åŒ—äº¬æ—¶é—´: $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')"
          echo "ğŸ“ å½“å‰ç›®å½•: $(pwd)"
          echo "ğŸ“„ æ–‡ä»¶åˆ—è¡¨:"
          ls -la
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      
      # æ­¥éª¤5ï¼šæ‰§è¡Œæé†’è„šæœ¬ï¼ˆæ ¸å¿ƒï¼‰
      - name: ğŸ¤– 5. æ‰§è¡Œæé†’æ£€æŸ¥è„šæœ¬
        id: reminder
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "â³ å¼€å§‹æ‰§è¡Œæé†’è„šæœ¬..."
          node scripts/send-reminder.js
          echo "âœ… è„šæœ¬æ‰§è¡Œå®Œæˆ"
      
      # æ­¥éª¤6ï¼šæäº¤æ›´æ–°åˆ°ä»“åº“
      - name: ğŸ’¾ 6. ä¿å­˜æ›´æ–°åˆ°GitHub
        run: |
          # é…ç½®Gitç”¨æˆ·ï¼ˆä½¿ç”¨actionsæœºå™¨äººï¼‰
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # æ·»åŠ reminders.jsonåˆ°æš‚å­˜åŒº
          git add reminders.json
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
          if git diff --staged --quiet; then
            echo "â„¹ï¸ reminders.json æ²¡æœ‰å˜åŒ–ï¼Œè·³è¿‡æäº¤"
          else
            # æäº¤æ›´æ”¹
            git commit -m "ğŸ“… è‡ªåŠ¨æ›´æ–°æé†’çŠ¶æ€ [$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M')] [skip ci]"
            
            # æ¨é€åˆ°ä»“åº“
            git push
            echo "âœ… å·²æˆåŠŸæäº¤æ›´æ–°åˆ°ä»“åº“"
            
            # æ˜¾ç¤ºæ›´æ–°å†…å®¹
            echo "ğŸ“Š æ›´æ–°æ‘˜è¦:"
            git show --stat
          fi
      
      # æ­¥éª¤7ï¼šå‘é€æˆåŠŸé€šçŸ¥ï¼ˆå¯é€‰ï¼‰
      - name: ğŸ“¢ 7. ä»»åŠ¡å®Œæˆé€šçŸ¥
        if: success()
        run: |
          echo "ğŸ‰ æ­å–œï¼æ‰€æœ‰æ­¥éª¤æ‰§è¡ŒæˆåŠŸï¼"
          echo "â° æ‰§è¡Œæ—¶é—´: $(TZ='Asia/Shanghai' date)"
          echo "ğŸ“¨ Telegramæé†’å·²å‘é€ï¼ˆå¦‚æœ‰åˆ°æœŸé¡¹ç›®ï¼‰"
      
      # æ­¥éª¤8ï¼šé”™è¯¯å¤„ç†
      - name: âŒ 8. é”™è¯¯å¤„ç†
        if: failure()
        run: |
          echo "âš ï¸ ä»»åŠ¡æ‰§è¡Œå¤±è´¥ï¼Œè¯·æ£€æŸ¥ï¼š"
          echo "1. GitHub Secretsæ˜¯å¦æ­£ç¡®é…ç½®"
          echo "2. Telegram Bot Tokenæ˜¯å¦æœ‰æ•ˆ"
          echo "3. reminders.jsonæ ¼å¼æ˜¯å¦æ­£ç¡®"
          exit 1
