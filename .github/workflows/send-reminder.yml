name: å®šæ—¶æé†’ç³»ç»Ÿ

on:
  # 1. æ¯å¤©æ—©ä¸Š11ç‚¹å‡†æ—¶æé†’ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰
  schedule:
    - cron: '0 3 * * *'   # UTC 3:00 = åŒ—äº¬æ—¶é—´ 11:00
  
  # 2. æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  
  # 3. å½“ reminders.json è¢«æ¨é€æ—¶è‡ªåŠ¨è§¦å‘ â†’ å®ç°ã€å½“å¤©æ–°å¢ç«‹å³æé†’ã€‘
  push:
    branches: [ main ]
    paths:
      - 'reminders.json'
  
  # 4. ä¿æŒæ´»è·ƒä¿¡å·ï¼ˆé˜²æ­¢60å¤©ä¼‘çœ ï¼‰
  repository_dispatch:
    types: [ping, check-reminders]

jobs:
  reminder:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: read
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true
          
      - name: â° è®¾ç½®åŒ—äº¬æ—¶é—´
        run: |
          sudo timedatectl set-timezone Asia/Shanghai
          echo "TODAY=$(date '+%Y-%m-%d')" >> $GITHUB_ENV
          echo "CURRENT_TIME=$(date '+%H:%M:%S')" >> $GITHUB_ENV
          echo "CURRENT_HOUR=$(date '+%H')" >> $GITHUB_ENV
          echo "CURRENT_MINUTE=$(date '+%M')" >> $GITHUB_ENV
          
      - name: ğŸ¤– æ™ºèƒ½æé†’ç³»ç»Ÿï¼ˆæ”¯æŒå½“å¤©æ–°å¢ç«‹å³æé†’ï¼‰
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          echo "========================================="
          echo "ğŸš€ å®šæ—¶æé†’ç³»ç»Ÿ Â· æ™ºèƒ½æ£€æµ‹"
          echo "â° åŒ—äº¬æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "ğŸ“Œ è§¦å‘æ–¹å¼: ${{ github.event_name }}"
          echo "========================================="
          
          # æ£€æŸ¥æé†’æ–‡ä»¶ï¼Œä¸å­˜åœ¨åˆ™åˆ›å»ºç©ºæ•°ç»„
          if [ ! -f "reminders.json" ]; then
            echo "[]" > reminders.json
            echo "ğŸ“ å·²åˆ›å»ºç©ºçš„ reminders.json"
            git add reminders.json
            git commit -m "åˆå§‹åŒ– reminders.json" || true
            git push || true
          fi
          
          # å®‰è£… jq
          sudo apt-get update -qq && sudo apt-get install -y jq -qq
          
          TODAY="${{ env.TODAY }}"
          CURRENT_HOUR="${{ env.CURRENT_HOUR }}"
          CURRENT_MINUTE="${{ env.CURRENT_MINUTE }}"
          
          echo "ğŸ“… ä»Šå¤©æ—¥æœŸ: $TODAY"
          echo "ğŸ• å½“å‰æ—¶é—´: $CURRENT_HOUR:$CURRENT_MINUTE"
          
          # åˆ¤æ–­è§¦å‘åœºæ™¯
          IS_PUSH_TRIGGER=false
          IS_MANUAL=false
          IS_SCHEDULE=false
          
          if [ "${{ github.event_name }}" == "push" ]; then
            IS_PUSH_TRIGGER=true
            echo "âš¡ è§¦å‘åœºæ™¯: æ¨é€äº‹ä»¶ â†’ ç«‹å³æ£€æŸ¥åˆ°æœŸé¡¹ç›®"
          elif [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            IS_MANUAL=true
            echo "ğŸ‘¤ è§¦å‘åœºæ™¯: æ‰‹åŠ¨è¿è¡Œ"
          elif [ "${{ github.event_name }}" == "schedule" ]; then
            IS_SCHEDULE=true
            echo "â° è§¦å‘åœºæ™¯: å®šæ—¶ä»»åŠ¡ (11:00)"
          else
            echo "ğŸ”„ è§¦å‘åœºæ™¯: æ´»è·ƒä¿¡å·"
          fi
          
          # è¯»å–æ‰€æœ‰æé†’
          COUNT=$(jq '. | length' reminders.json)
          echo "ğŸ“‹ å…±æœ‰ $COUNT ä¸ªæé†’é¡¹ç›®"
          echo ""
          
          SENT=0
          UPDATED=0
          DUE_ITEMS=""
          INDEX=1
          NEED_COMMIT=false
          UPDATED_IDS=""
          
          # éå†æ‰€æœ‰æé†’
          for i in $(seq 0 $((COUNT-1))); do
            NAME=$(jq -r ".[$i].name" reminders.json)
            NEXT=$(jq -r ".[$i].nextReminder" reminders.json)
            DAYS=$(jq -r ".[$i].days" reminders.json)
            LAST=$(jq -r ".[$i].lastUpdated // \"æœªçŸ¥\"" reminders.json)
            NOTIFIED=$(jq -r ".[$i].notified // false" reminders.json)
            ID=$(jq -r ".[$i].id" reminders.json)
            
            # æ£€æŸ¥æ˜¯å¦æ˜¯ä»Šå¤©åˆ°æœŸ
            if [ "$NEXT" == "$TODAY" ]; then
              echo "âš ï¸ åˆ°æœŸæé†’: $NAME"
              
              # æ·»åŠ åˆ°åˆ°æœŸåˆ—è¡¨
              DUE_ITEMS="${DUE_ITEMS}â”œâ”€ $NAME (å‘¨æœŸ: ${DAYS}å¤©)\n"
              
              # ========== æ™ºèƒ½æé†’ç­–ç•¥ ==========
              # åªè¦æ»¡è¶³ä»¥ä¸‹ä»»ä¸€æ¡ä»¶å°±å‘é€æé†’ï¼š
              # 1. ä»æœªé€šçŸ¥è¿‡ (notified == false)
              # 2. æ‰‹åŠ¨è§¦å‘ ä¸” å·²è¿‡11ç‚¹
              # 3. æ¨é€è§¦å‘ ä¸” å·²è¿‡11ç‚¹ï¼ˆå½“å¤©æ–°å¢é¡¹ç›®ï¼‰
              # 4. å®šæ—¶ä»»åŠ¡ï¼ˆ11:00ï¼‰æ­£å¸¸è§¦å‘
              # ==================================
              
              SEND_NOW=false
              
              if [ "$NOTIFIED" == "false" ]; then
                SEND_NOW=true
                echo "  ğŸ“¤ åŸå› : ä»æœªå‘é€è¿‡æé†’"
              elif [ "$IS_PUSH_TRIGGER" == "true" ] && [ "$CURRENT_HOUR" -ge 11 ]; then
                SEND_NOW=true
                echo "  ğŸ“¤ åŸå› : æ¨é€è§¦å‘ä¸”å·²è¿‡11ç‚¹ â†’ å½“å¤©æ–°å¢é¡¹ç›®ç«‹å³æé†’"
              elif [ "$IS_MANUAL" == "true" ] && [ "$CURRENT_HOUR" -ge 11 ]; then
                SEND_NOW=true
                echo "  ğŸ“¤ åŸå› : æ‰‹åŠ¨è§¦å‘ä¸”å·²è¿‡11ç‚¹"
              elif [ "$IS_SCHEDULE" == "true" ]; then
                SEND_NOW=true
                echo "  ğŸ“¤ åŸå› : å®šæ—¶ä»»åŠ¡æ‰§è¡Œ"
              fi
              
              if [ "$SEND_NOW" == "true" ]; then
                echo "  ğŸ“¤ æ­£åœ¨å‘é€ Telegram æé†’..."
                
                # è®¡ç®—ä¸‹æ¬¡æé†’æ—¥æœŸ
                NEXT_DATE=$(date -d "$TODAY + $DAYS days" '+%Y-%m-%d')
                
                # æ„å»º Telegram æ¶ˆæ¯
                MESSAGE="â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—%0A"
                MESSAGE="${MESSAGE}â•‘  ğŸ”” åˆ°æœŸäº‹åŠ¡æé†’%0A"
                MESSAGE="${MESSAGE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•%0A%0A"
                MESSAGE="${MESSAGE}ğŸ“Œ <b>${NAME}</b>%0A"
                MESSAGE="${MESSAGE}â”œâ”€ ä¸Šæ¬¡æ›´æ–°: ${LAST}%0A"
                MESSAGE="${MESSAGE}â”œâ”€ æœ¬æ¬¡æé†’: ä»Šå¤© ${TODAY}%0A"
                MESSAGE="${MESSAGE}â”œâ”€ é—´éš”å‘¨æœŸ: ${DAYS} å¤©%0A"
                MESSAGE="${MESSAGE}â””â”€ ä¸‹æ¬¡æé†’: ${NEXT_DATE}%0A%0A"
                MESSAGE="${MESSAGE}âš¡ï¸ è¯·åŠæ—¶å¤„ç†"
                
                # å‘é€ Telegram
                RESPONSE=$(curl -s -X POST \
                  "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
                  -d "chat_id=${TELEGRAM_CHAT_ID}" \
                  -d "text=${MESSAGE}" \
                  -d "parse_mode=HTML")
                
                if echo "$RESPONSE" | grep -q '"ok":true'; then
                  echo "  âœ… Telegram å‘é€æˆåŠŸ"
                  SENT=$((SENT+1))
                  
                  # æ›´æ–° JSON æ–‡ä»¶
                  # 1. æ›´æ–°æœ€åæ›´æ–°æ—¥æœŸä¸ºä»Šå¤©
                  # 2. æ›´æ–°ä¸‹æ¬¡æé†’æ—¥æœŸ
                  # 3. æ ‡è®°å·²é€šçŸ¥
                  # 4. è®°å½•å‘é€æ—¶é—´
                  
                  jq ".[$i].lastUpdated = \"$TODAY\"" reminders.json > tmp.json && mv tmp.json reminders.json
                  jq ".[$i].nextReminder = \"$NEXT_DATE\"" reminders.json > tmp.json && mv tmp.json reminders.json
                  jq ".[$i].notified = true" reminders.json > tmp.json && mv tmp.json reminders.json
                  jq ".[$i].lastSentTime = \"$(date -Iseconds)\"" reminders.json > tmp.json && mv tmp.json reminders.json
                  
                  echo "  âœ… ä¸‹æ¬¡æé†’å·²æ›´æ–°ä¸º: $NEXT_DATE"
                  UPDATED=$((UPDATED+1))
                  NEED_COMMIT=true
                  UPDATED_IDS="${UPDATED_IDS}${ID},"
                else
                  echo "  âŒ Telegram å‘é€å¤±è´¥"
                fi
              else
                echo "  â¹ï¸ ä»Šå¤©å·²å‘é€è¿‡æé†’ï¼Œä¸å†é‡å¤å‘é€"
              fi
              
              INDEX=$((INDEX+1))
            fi
          done
          
          # å‘é€æ±‡æ€»æ¶ˆæ¯ï¼ˆå¦‚æœæœ‰å¤šä¸ªåˆ°æœŸé¡¹ç›®ï¼‰
          if [ $SENT -gt 1 ]; then
            echo ""
            echo "ğŸ“Š å‘é€æ±‡æ€»æ¶ˆæ¯..."
            
            SUMMARY="â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—%0A"
            SUMMARY="${SUMMARY}â•‘  ğŸ“Š ä»Šæ—¥åˆ°æœŸæ±‡æ€»%0A"
            SUMMARY="${SUMMARY}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•%0A%0A"
            SUMMARY="${SUMMARY}å…± <b>${SENT}</b> ä¸ªé¡¹ç›®éœ€è¦å¤„ç†ï¼š%0A"
            SUMMARY="${SUMMARY}$DUE_ITEMS"
            SUMMARY="${SUMMARY}%0Aâ±ï¸ å‘é€æ—¶é—´: ${{ env.CURRENT_TIME }}"
            
            curl -s -X POST \
              "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              -d "chat_id=${TELEGRAM_CHAT_ID}" \
              -d "text=${SUMMARY}" \
              -d "parse_mode=HTML" || true
          fi
          
          echo ""
          echo "------------------------"
          echo "ğŸ“Š æœ¬æ¬¡è¿è¡Œç»Ÿè®¡:"
          echo "   â€¢ å‘é€æé†’: $SENT æ¡"
          echo "   â€¢ æ›´æ–°æ—¥æœŸ: $UPDATED ä¸ª"
          echo ""
          
          # æäº¤æ›´æ–°åˆ° GitHub
          if [ "$NEED_COMMIT" == "true" ]; then
            echo "ğŸ”„ è‡ªåŠ¨æäº¤æ›´æ–°åˆ° GitHub..."
            
            git config --global user.name "Reminder Bot"
            git config --global user.email "reminder-bot@users.noreply.github.com"
            
            git add reminders.json
            git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–°æé†’æ—¥æœŸ [$(date '+%Y-%m-%d %H:%M')] å·²é€šçŸ¥: ${UPDATED_IDS}" || true
            git push
            
            echo "âœ… GitHub æ›´æ–°æˆåŠŸ"
          else
            echo "â„¹ï¸ æ— éœ€æ›´æ–°"
          fi
          
          echo ""
          echo "========================================="
          echo "âœ… è‡ªåŠ¨æ‰§è¡Œå®Œæˆ"
          echo "========================================="
