name: å®šæ—¶æé†’ç³»ç»Ÿ

on:
  schedule:
    - cron: '*/3 * * * *'   # æ¯3åˆ†é’Ÿè¿è¡Œä¸€æ¬¡
  workflow_dispatch:         # æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write

jobs:
  send-reminder:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ ä¸‹è½½ä»£ç 
        uses: actions/checkout@v3
        with:
          fetch-depth: 1
          
      - name: ğŸ”§ è®¾ç½®Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          
      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: npm install node-fetch@2
        
      - name: ğŸ¤– æ‰§è¡Œæé†’
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          echo "==================================="
          echo "ğŸš€ å¼€å§‹æ‰§è¡Œæé†’ä»»åŠ¡"
          echo "==================================="
          echo "â° åŒ—äº¬æ—¶é—´: $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')"
          echo ""
          
          # ============ 1. æµ‹è¯•Telegramè¿æ¥ï¼ˆå…³é”®æ­¥éª¤ï¼‰ ============
          echo "ğŸ“¤ æ­£åœ¨å‘é€æµ‹è¯•æ¶ˆæ¯åˆ°Telegram..."
          
          TEST_URL="https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage"
          TEST_DATA="chat_id=${TELEGRAM_CHAT_ID}&text=âœ… GitHub Actions è¿æ¥æµ‹è¯•æˆåŠŸ%0Aâ° æ—¶é—´: $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')%0AğŸ“¦ ä»“åº“: ${{ github.repository }}"
          
          curl -s -X POST "$TEST_URL" -d "$TEST_DATA"
          
          if [ $? -eq 0 ]; then
            echo "âœ… Telegram æµ‹è¯•æ¶ˆæ¯å‘é€æˆåŠŸï¼"
          else
            echo "âŒ Telegram æµ‹è¯•æ¶ˆæ¯å‘é€å¤±è´¥ï¼"
            echo "   è¯·æ£€æŸ¥ Secrets é…ç½®æ˜¯å¦æ­£ç¡®"
            exit 1
          fi
          
          echo ""
          echo "==================================="
          echo "ğŸ“‹ å¼€å§‹å¤„ç†æé†’æ•°æ®"
          echo "==================================="
          
          # ============ 2. Node.js è„šæœ¬å¤„ç†æé†’ ============
          node << 'EOF'
          const fs = require('fs');
          const https = require('https');

          // è·å–åŒ—äº¬æ—¶é—´
          function getBeijingDate() {
            const now = new Date();
            now.setHours(now.getHours() + 8);
            return now.toISOString().split('T')[0];
          }

          // è·å–åŒ—äº¬æ—¶é—´ï¼ˆå®Œæ•´æ ¼å¼ï¼‰
          function getBeijingTime() {
            const now = new Date();
            now.setHours(now.getHours() + 8);
            return now.toLocaleString('zh-CN', { hour12: false, timeZone: 'Asia/Shanghai' });
          }

          // è®¡ç®—ä¸‹æ¬¡æé†’æ—¥æœŸ
          function getNextDate(dateStr, days) {
            const date = new Date(dateStr);
            date.setDate(date.getDate() + days);
            return date.toISOString().split('T')[0];
          }

          // ä¸»å‡½æ•°
          async function main() {
            console.log('ğŸ“… ä»Šæ—¥æ—¥æœŸ:', getBeijingDate());
            
            // è¯»å–æé†’æ•°æ®
            let reminders = [];
            try {
              if (fs.existsSync('reminders.json')) {
                const data = fs.readFileSync('reminders.json', 'utf8');
                reminders = JSON.parse(data);
                console.log(`ğŸ“¦ åŠ è½½æé†’: ${reminders.length} ä¸ª`);
              } else {
                console.log('ğŸ“ æé†’æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ›å»ºé»˜è®¤æ•°æ®');
                reminders = [{
                  id: Date.now(),
                  name: 'æµ‹è¯•æé†’',
                  lastUpdated: getBeijingDate(),
                  nextReminder: getBeijingDate(),
                  days: 1,
                  enabled: true,
                  notified: false,
                  lastSentTime: null
                }];
              }
            } catch (e) {
              console.error('âŒ è¯»å–å¤±è´¥:', e.message);
              process.exit(1);
            }

            const today = getBeijingDate();
            
            // æ‰¾å‡ºä»Šæ—¥åˆ°æœŸä¸”æœªå®Œæˆçš„é¡¹ç›®
            const dueReminders = reminders.filter(r => 
              r.enabled !== false && r.nextReminder === today
            );

            console.log(`ğŸ”” ä»Šæ—¥åˆ°æœŸ: ${dueReminders.length} ä¸ª`);

            if (dueReminders.length === 0) {
              console.log('â„¹ï¸ ä»Šæ—¥æ— åˆ°æœŸæé†’');
              process.exit(0);
            }

            // æ£€æŸ¥3åˆ†é’Ÿå†…æ˜¯å¦å‘é€è¿‡
            const now = Date.now();
            const THREE_MINUTES = 3 * 60 * 1000;
            
            const needSend = dueReminders.filter(r => {
              if (!r.lastSentTime) return true;
              return now - new Date(r.lastSentTime).getTime() > THREE_MINUTES;
            });

            if (needSend.length === 0) {
              console.log('â¸ï¸ æ‰€æœ‰é¡¹ç›®3åˆ†é’Ÿå†…å·²æé†’è¿‡ï¼Œè·³è¿‡æœ¬æ¬¡');
              process.exit(0);
            }

            console.log(`ğŸ“¤ æœ¬æ¬¡å‘é€: ${needSend.length} ä¸ª`);

            // æ„é€ æ¶ˆæ¯
            let message = 'ğŸ”” *å®šæ—¶æé†’ç³»ç»Ÿ*\n';
            message += 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n';
            message += `ğŸ“… æ—¥æœŸï¼š${today}\n`;
            message += `â° æ—¶é—´ï¼š${getBeijingTime()}\n`;
            message += `â±ï¸ é¢‘ç‡ï¼šæ¯3åˆ†é’Ÿæé†’ä¸€æ¬¡\n\n`;
            message += `*ä»Šæ—¥åˆ°æœŸé¡¹ç›®ï¼ˆ${dueReminders.length}é¡¹ï¼‰ï¼š*\n\n`;

            dueReminders.forEach((item, index) => {
              const nextDate = getNextDate(today, item.days);
              message += `${index + 1}. *${item.name}*\n`;
              message += `   â€¢ å‘¨æœŸï¼šæ¯ ${item.days} å¤©\n`;
              message += `   â€¢ æœ€åæ›´æ–°ï¼š${item.lastUpdated}\n`;
              message += `   â€¢ ä¸‹æ¬¡æé†’ï¼š${nextDate}\n`;
              message += `   â€¢ çŠ¶æ€ï¼šâš ï¸ ç­‰å¾…å¤„ç†\n\n`;

              // æ›´æ–°å‘é€æ—¶é—´
              item.lastSentTime = new Date().toISOString();
              item.notified = false;
            });

            message += 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n';
            message += 'âœ… *å¤„ç†å®Œæˆåï¼Œè¯·ç‚¹å‡»ä¸‹æ–¹é“¾æ¥æ›´æ–°çŠ¶æ€ï¼š*\n';
            message += `[âš™ï¸ ç‚¹å‡»è¿™é‡Œç®¡ç†æé†’](https://github.com/${process.env.GITHUB_REPOSITORY}/blob/main/README.md)\n\n`;
            message += 'ğŸ”„ ç³»ç»Ÿå°†æŒç»­æé†’ï¼Œç›´åˆ°æ‚¨ç‚¹å‡»"è®¾ä¸ºä»Šå¤©"';

            // å‘é€åˆ°Telegram
            const token = process.env.TELEGRAM_BOT_TOKEN;
            const chatId = process.env.TELEGRAM_CHAT_ID;
            
            if (!token || !chatId) {
              console.error('âŒ é”™è¯¯: Secretsæœªé…ç½®');
              process.exit(1);
            }

            const url = `https://api.telegram.org/bot${token}/sendMessage`;
            const postData = JSON.stringify({
              chat_id: chatId,
              text: message,
              parse_mode: 'Markdown',
              disable_web_page_preview: false
            });

            return new Promise((resolve, reject) => {
              const req = https.request(url, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Content-Length': Buffer.byteLength(postData)
                }
              }, (res) => {
                let data = '';
                res.on('data', chunk => data += chunk);
                res.on('end', () => {
                  try {
                    const result = JSON.parse(data);
                    if (result.ok) {
                      console.log(`âœ… å‘é€æˆåŠŸ: ${needSend.length} æ¡`);
                      // ä¿å­˜æ•°æ®
                      fs.writeFileSync('reminders.json', JSON.stringify(reminders, null, 2));
                      console.log('ğŸ’¾ å‘é€æ—¶é—´å·²è®°å½•');
                      resolve();
                    } else {
                      console.error('âŒ å‘é€å¤±è´¥:', result.description);
                      reject(new Error(result.description));
                    }
                  } catch (e) {
                    reject(e);
                  }
                });
              });

              req.on('error', reject);
              req.write(postData);
              req.end();
            });
          }

          main().catch(error => {
            console.error('âŒ ç¨‹åºé”™è¯¯:', error.message);
            process.exit(1);
          });
          EOF
          
      - name: ğŸ’¾ ä¿å­˜æ›´æ”¹
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add reminders.json
          if git diff --staged --quiet; then
            echo "â„¹ï¸ æ²¡æœ‰æ•°æ®æ›´æ–°"
          else
            git commit -m "ğŸ“… è‡ªåŠ¨æ›´æ–°å‘é€æ—¶é—´ [$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M')]"
            git push
            echo "âœ… å·²æäº¤æ›´æ–°"
          fi
