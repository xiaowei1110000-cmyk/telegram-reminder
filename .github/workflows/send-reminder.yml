name: å®šæ—¶æé†’ç³»ç»Ÿ

on:
  schedule:
    - cron: '*/5 * * * *'   # æ¯5åˆ†é’Ÿè¿è¡Œä¸€æ¬¡ï¼ˆæµ‹è¯•ç”¨ï¼‰
    - cron: '0 3 * * *'      # æ¯å¤©11:00ï¼ˆæ­£å¼ï¼‰
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'reminders.json'

jobs:
  reminder:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v3
          
      - name: è®¾ç½®åŒ—äº¬æ—¶é—´
        run: |
          sudo timedatectl set-timezone Asia/Shanghai
          echo "TODAY=$(date '+%Y-%m-%d')" >> $GITHUB_ENV
          echo "HOUR=$(date '+%H')" >> $GITHUB_ENV
          
      - name: æ£€æŸ¥å¹¶å‘é€æé†’
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          echo "========== å®šæ—¶æé†’ç³»ç»Ÿ =========="
          echo "æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          
          # å®‰è£… jq
          sudo apt-get update -qq && sudo apt-get install -y jq -qq
          
          TODAY="${{ env.TODAY }}"
          HOUR="${{ env.HOUR }}"
          echo "ä»Šå¤©æ—¥æœŸ: $TODAY"
          echo "å½“å‰å°æ—¶: $HOUR"
          
          # æ£€æŸ¥æ–‡ä»¶
          if [ ! -f "reminders.json" ]; then
            echo "é”™è¯¯: reminders.json ä¸å­˜åœ¨"
            exit 1
          fi
          
          # è¯»å–æé†’
          COUNT=$(jq '. | length' reminders.json)
          echo "å…±æœ‰ $COUNT ä¸ªæé†’é¡¹ç›®"
          
          # æ ‡è®°æ˜¯å¦æœ‰æ›´æ–°
          UPDATED=false
          
          # éå†æ£€æŸ¥
          for i in $(seq 0 $((COUNT-1))); do
            NAME=$(jq -r ".[$i].name" reminders.json)
            NEXT=$(jq -r ".[$i].nextReminder" reminders.json)
            DAYS=$(jq -r ".[$i].days" reminders.json)
            LAST=$(jq -r ".[$i].lastUpdated" reminders.json)
            NOTIFIED=$(jq -r ".[$i].notified // false" reminders.json)
            
            if [ "$NEXT" == "$TODAY" ]; then
              echo ""
              echo "åˆ°æœŸé¡¹ç›®: $NAME"
              echo "é€šçŸ¥çŠ¶æ€: $NOTIFIED"
              
              # åªæœ‰åœ¨ä»¥ä¸‹æƒ…å†µæ‰å‘é€ï¼š
              # 1. ä»æœªé€šçŸ¥è¿‡
              # 2. æˆ–è€…ä»Šå¤©æ˜¯ç¬¬ä¸€æ¬¡è¿è¡Œï¼ˆ11ç‚¹åï¼‰
              if [ "$NOTIFIED" == "false" ] || [ "$HOUR" -ge "11" ]; then
                echo "å‘é€ Telegram æé†’..."
                
                # è®¡ç®—ä¸‹æ¬¡æé†’
                NEXT_DATE=$(date -d "$TODAY + $DAYS days" '+%Y-%m-%d')
                
                # å‘é€ Telegram
                MESSAGE="ğŸ”” åˆ°æœŸæé†’%0A%0A"
                MESSAGE="${MESSAGE}é¡¹ç›®: ${NAME}%0A"
                MESSAGE="${MESSAGE}ä¸Šæ¬¡æ›´æ–°: ${LAST}%0A"
                MESSAGE="${MESSAGE}æœ¬æ¬¡æé†’: ä»Šå¤© ${TODAY}%0A"
                MESSAGE="${MESSAGE}ä¸‹æ¬¡æé†’: ${NEXT_DATE}"
                
                curl -s -X POST \
                  "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
                  -d "chat_id=${TELEGRAM_CHAT_ID}" \
                  -d "text=${MESSAGE}" \
                  -d "parse_mode=HTML"
                
                echo "âœ… å·²å‘é€"
                
                # æ›´æ–°æ—¥æœŸå’Œé€šçŸ¥çŠ¶æ€
                jq ".[$i].lastUpdated = \"$TODAY\"" reminders.json > tmp.json
                jq ".[$i].nextReminder = \"$NEXT_DATE\"" tmp.json > reminders.json
                jq ".[$i].notified = true" reminders.json > tmp.json
                jq ".[$i].lastSentTime = \"$(date -Iseconds)\"" tmp.json > reminders.json
                rm tmp.json 2>/dev/null || true
                
                UPDATED=true
              else
                echo "â¸ï¸ ä»Šå¤©å·²é€šçŸ¥è¿‡ï¼Œä¸å†é‡å¤å‘é€"
              fi
            fi
          done
          
          # å¦‚æœæœ‰æ›´æ–°ï¼Œæäº¤åˆ° GitHub
          if [ "$UPDATED" == "true" ]; then
            echo ""
            echo "æäº¤æ›´æ–°åˆ° GitHub..."
            
            git config --global user.name "Reminder Bot"
            git config --global user.email "reminder-bot@users.noreply.github.com"
            
            git add reminders.json
            git commit -m "è‡ªåŠ¨æ›´æ–°æé†’æ—¥æœŸ $(date '+%Y-%m-%d %H:%M')" || true
            git push
            
            echo "âœ… æ›´æ–°å®Œæˆ"
          fi
          
          echo ""
          echo "========== å®Œæˆ =========="
