# ============================================
# GitHubå®šæ—¶æé†’ç³»ç»Ÿ - è‡ªåŠ¨åŒ–å·¥ä½œæµ
# åŠŸèƒ½ï¼šæ¯å¤©11:00è‡ªåŠ¨è¿è¡Œï¼Œæ°¸ä¸é—´æ–­
# ä½œè€…ï¼šxiaowei1110000-cmyk
# ============================================

name: ğŸš€ è‡ªåŠ¨æé†’ç³»ç»Ÿ

# è§¦å‘æ¡ä»¶
on:
  # 1. å®šæ—¶è§¦å‘ - æ¯å¤©åŒ—äº¬æ—¶é—´11:00
  schedule:
    - cron: '0 3 * * *'
  
  # 2. æ‰‹åŠ¨è§¦å‘ - ç”¨äºæµ‹è¯•
  workflow_dispatch:

# æƒé™è®¾ç½® - å¿…é¡»è¦æœ‰å†™å…¥æƒé™
permissions:
  contents: write
  actions: read

# å…¨å±€ç¯å¢ƒå˜é‡
env:
  TZ: Asia/Shanghai
  NODE_VERSION: '18'

jobs:
  telegram-reminder:
    name: ğŸ“¨ å‘é€Telegramæé†’
    runs-on: ubuntu-latest
    
    steps:
      # æ­¥éª¤1: æ£€å‡ºä»£ç 
      - name: ğŸ“¥ 1. è·å–ä»£ç 
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      # æ­¥éª¤2: è®¾ç½®Node.js
      - name: ğŸ”§ 2. é…ç½®Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      # æ­¥éª¤3: å®‰è£…ä¾èµ–
      - name: ğŸ“¦ 3. å®‰è£…node-fetch
        run: npm install node-fetch@2
      
      # æ­¥éª¤4: æ‰§è¡Œæé†’è„šæœ¬
      - name: ğŸ¤– 4. æ‰§è¡Œæé†’æ£€æŸ¥
        id: reminder
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          echo "â° å¼€å§‹æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "ğŸ“… ä»Šæ—¥æ—¥æœŸ: $(TZ='Asia/Shanghai' date '+%Y-%m-%d')"
          
          # åˆ›å»ºå¹¶æ‰§è¡Œè„šæœ¬
          cat > reminder.js << 'EOF'
// ==================== æ ¸å¿ƒæé†’ç³»ç»Ÿ ====================
const fs = require('fs');
const fetch = require('node-fetch');

// 1. è·å–åŒ—äº¬æ—¶é—´
function getBeijingDate() {
    const now = new Date();
    now.setHours(now.getHours() + 8);
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}

// 2. è®¡ç®—ä¸‹æ¬¡æé†’æ—¥æœŸ
function getNextDate(lastDate, days) {
    const date = new Date(lastDate);
    date.setDate(date.getDate() + days);
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}

// 3. ä¸»å‡½æ•°
async function main() {
    console.log('\n' + '='.repeat(60));
    console.log('ğŸš€ GitHubå®šæ—¶æé†’ç³»ç»Ÿ å¼€å§‹è¿è¡Œ');
    console.log('='.repeat(60));
    
    // è¯»å–æ•°æ®
    let reminders = [];
    try {
        const data = fs.readFileSync('reminders.json', 'utf8');
        reminders = JSON.parse(data);
        console.log(`ğŸ“¦ åŠ è½½æé†’: ${reminders.length} ä¸ª`);
    } catch (e) {
        console.log('âŒ è¯»å–å¤±è´¥ï¼Œä½¿ç”¨ç©ºæ•°æ®');
        reminders = [];
    }
    
    const today = getBeijingDate();
    console.log(`ğŸ“… ä»Šæ—¥æ—¥æœŸ: ${today}`);
    
    // æ‰¾å‡ºä»Šæ—¥åˆ°æœŸä¸”æœªæé†’çš„é¡¹ç›®
    const dueList = reminders.filter(r => {
        return r.enabled !== false && 
               r.nextReminder === today && 
               !r.notified;
    });
    
    console.log(`ğŸ”” ä»Šæ—¥åˆ°æœŸ: ${dueList.length} ä¸ª`);
    
    // å¦‚æœæœ‰åˆ°æœŸé¡¹ç›®ï¼Œå‘é€æé†’
    if (dueList.length > 0) {
        const token = process.env.TELEGRAM_BOT_TOKEN;
        const chatId = process.env.TELEGRAM_CHAT_ID;
        
        if (!token || !chatId) {
            console.log('âŒ æœªé…ç½®Telegram');
            process.exit(1);
        }
        
        // æ ¼å¼åŒ–æ¶ˆæ¯
        let msg = 'ğŸ”” *å®šæ—¶æé†’ç³»ç»Ÿ*\n';
        msg += 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n';
        msg += `ğŸ“… æ—¥æœŸï¼š${today}\n`;
        msg += `â° æ—¶é—´ï¼š${new Date().toLocaleTimeString('zh-CN', {timeZone: 'Asia/Shanghai'})}\n\n`;
        msg += `*ä»Šæ—¥éœ€è¦å¤„ç†ï¼ˆ${dueList.length}é¡¹ï¼‰ï¼š*\n\n`;
        
        dueList.forEach((item, i) => {
            const nextDate = getNextDate(today, item.days);
            msg += `${i+1}. *${item.name}*\n`;
            msg += `   â€¢ å‘¨æœŸï¼šæ¯${item.days}å¤©\n`;
            msg += `   â€¢ ä¸‹æ¬¡ï¼š${nextDate}\n\n`;
            
            // æ›´æ–°çŠ¶æ€
            item.lastUpdated = today;
            item.nextReminder = nextDate;
            item.notified = true;
            item.lastNotified = new Date().toISOString();
        });
        
        msg += 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n';
        msg += `[ç®¡ç†æé†’](https://github.com/${process.env.GITHUB_REPOSITORY})`;
        
        // å‘é€Telegram
        console.log('ğŸ“¤ å‘é€Telegramæ¶ˆæ¯...');
        const url = `https://api.telegram.org/bot${token}/sendMessage`;
        const res = await fetch(url, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                chat_id: chatId,
                text: msg,
                parse_mode: 'Markdown',
                disable_web_page_preview: true
            })
        });
        
        const result = await res.json();
        
        if (result.ok) {
            console.log(`âœ… å‘é€æˆåŠŸ: ${dueList.length} æ¡æé†’`);
            // ä¿å­˜æ›´æ–°
            fs.writeFileSync('reminders.json', JSON.stringify(reminders, null, 2));
            console.log('ğŸ’¾ æ•°æ®å·²æ›´æ–°');
        } else {
            console.log('âŒ å‘é€å¤±è´¥:', result.description);
        }
    } else {
        console.log('â„¹ï¸ ä»Šæ—¥æ— åˆ°æœŸæé†’');
    }
    
    console.log('='.repeat(60));
    console.log('âœ¨ æ‰§è¡Œå®Œæˆ');
    console.log('='.repeat(60));
}

main().catch(console.error);
EOF

          node reminder.js
      
      # æ­¥éª¤5: æäº¤æ›´æ–°
      - name: ğŸ’¾ 5. ä¿å­˜åˆ°ä»“åº“
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add reminders.json
          if git diff --staged --quiet; then
            echo "â„¹ï¸ æ— æ•°æ®æ›´æ–°"
          else
            git commit -m "ğŸ“… è‡ªåŠ¨æ›´æ–°æé†’ [$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M')]"
            git push
            echo "âœ… å·²æäº¤æ›´æ–°"
          fi
