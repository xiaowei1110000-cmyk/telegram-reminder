name: å®šæ—¶æé†’ç³»ç»Ÿ

on:
  # æ–¹æ¡ˆ1ï¼šå¸¸è§„å®šæ—¶ï¼ˆä½†å¯èƒ½æœ‰å»¶è¿Ÿï¼‰
  schedule:
    - cron: '*/3 * * * *'      # æ¯3åˆ†é’Ÿ
  
  # æ–¹æ¡ˆ2ï¼šä»£ç æ¨é€æ—¶è§¦å‘ï¼ˆå”¤é†’æœºåˆ¶ï¼‰
  push:
    branches: [ main ]
    paths:
      - 'reminders.json'       # æé†’æ•°æ®å˜æ›´ç«‹å³è§¦å‘
  
  # æ–¹æ¡ˆ3ï¼šæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  
  # æ–¹æ¡ˆ4ï¼šä»“åº“è¢«è®¿é—®æ—¶è§¦å‘ï¼ˆé€šè¿‡å¤–éƒ¨pingï¼‰
  repository_dispatch:
    types: [ping]

jobs:
  reminder:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v3
        with:
          fetch-depth: 1
          
      - name: â° è®¾ç½®åŒ—äº¬æ—¶é—´
        run: |
          sudo timedatectl set-timezone Asia/Shanghai
          echo "TZ='Asia/Shanghai'" >> $GITHUB_ENV
          
      - name: ğŸ” æ‰§è¡Œæé†’æ£€æŸ¥
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          # æ˜¾ç¤ºæ—¶é—´
          echo "========================================="
          echo "âœ… å®šæ—¶æé†’ç³»ç»Ÿå·²å¯åŠ¨"
          echo "â° åŒ—äº¬æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "ğŸ¯ è§¦å‘æ–¹å¼: ${{ github.event_name }}"
          echo "========================================="
          
          # å‘é€ä¸€æ¡é€šçŸ¥ï¼Œè¯æ˜ç³»ç»Ÿåœ¨å·¥ä½œ
          if [ -n "$TELEGRAM_BOT_TOKEN" ] && [ -n "$TELEGRAM_CHAT_ID" ]; then
            curl -s -X POST \
              "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              -d "chat_id=${TELEGRAM_CHAT_ID}" \
              -d "text=âœ… å®šæ—¶æé†’ç³»ç»Ÿå·²å”¤é†’%0Aâ° æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')%0AğŸ¯ è§¦å‘: ${{ github.event_name }}" \
              -d "parse_mode=HTML" > /dev/null
          fi
          
          # æ£€æŸ¥æé†’æ–‡ä»¶
          if [ ! -f "reminders.json" ]; then
            echo "âš ï¸ reminders.json ä¸å­˜åœ¨"
            echo '[]' > reminders.json
          fi
          
          # å®‰è£… jq
          sudo apt-get update -qq && sudo apt-get install -y jq -qq
          
          # ä»Šå¤©æ—¥æœŸ
          TODAY=$(date '+%Y-%m-%d')
          echo "ğŸ“… ä»Šå¤©æ—¥æœŸ: $TODAY"
          
          # è¯»å–æé†’
          COUNT=$(jq '. | length' reminders.json)
          echo "ğŸ“‹ å…±æœ‰ $COUNT ä¸ªæé†’"
          
          SENT=0
          
          # éå†æé†’
          for i in $(seq 0 $((COUNT-1))); do
            NAME=$(jq -r ".[$i].name" reminders.json)
            NEXT=$(jq -r ".[$i].nextReminder" reminders.json)
            DAYS=$(jq -r ".[$i].days" reminders.json)
            NOTIFIED=$(jq -r ".[$i].notified // false" reminders.json)
            
            echo "------------------------"
            echo "ğŸ“Œ $NAME"
            echo "ğŸ“… ä¸‹æ¬¡æé†’: $NEXT"
            
            # å¦‚æœä»Šå¤©åˆ°æœŸä¸”æœªé€šçŸ¥
            if [ "$NEXT" == "$TODAY" ] && [ "$NOTIFIED" == "false" ]; then
              echo "âš ï¸ ä»Šæ—¥åˆ°æœŸï¼Œå‘é€æé†’..."
              
              if [ -n "$TELEGRAM_BOT_TOKEN" ] && [ -n "$TELEGRAM_CHAT_ID" ]; then
                MESSAGE="ğŸ”” <b>å®šæ—¶æé†’</b>%0A%0AğŸ“Œ <b>åç§°ï¼š</b>${NAME}%0AğŸ“… <b>æ—¥æœŸï¼š</b>${TODAY}%0Aâ° <b>é—´éš”ï¼š</b>${DAYS}å¤©%0A%0Aè¯·åŠæ—¶å¤„ç†ï¼"
                
                curl -s -X POST \
                  "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
                  -d "chat_id=${TELEGRAM_CHAT_ID}" \
                  -d "text=${MESSAGE}" \
                  -d "parse_mode=HTML"
                
                if [ $? -eq 0 ]; then
                  echo "âœ… å‘é€æˆåŠŸ"
                  SENT=$((SENT+1))
                  
                  # æ ‡è®°ä¸ºå·²é€šçŸ¥
                  jq ".[$i].notified = true" reminders.json > tmp.json && mv tmp.json reminders.json
                  jq ".[$i].lastSentTime = \"$(date -Iseconds)\"" reminders.json > tmp.json && mv tmp.json reminders.json
                fi
              fi
            elif [ "$NEXT" == "$TODAY" ] && [ "$NOTIFIED" == "true" ]; then
              echo "â¹ï¸ ä»Šå¤©å·²å‘é€è¿‡"
            else
              echo "âœ… æœªåˆ°æœŸ"
            fi
          done
          
          echo "------------------------"
          echo "ğŸ“Š æœ¬æ¬¡å‘é€: $SENT æ¡"
          
          # å¦‚æœæœ‰å‘é€æˆåŠŸï¼Œæäº¤æ›´æ–°
          if [ $SENT -gt 0 ]; then
            echo "ğŸ”„ æäº¤æ›´æ–°åˆ°GitHub..."
            git config --global user.name "Reminder Bot"
            git config --global user.email "bot@reminder.system"
            git add reminders.json
            git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–°æé†’çŠ¶æ€ [$(date '+%Y-%m-%d %H:%M')]"
            git push
            echo "âœ… æ›´æ–°å®Œæˆ"
          fi
          
          echo "========================================="
          echo "âœ¨ æ‰§è¡Œå®Œæˆ"
          echo "========================================="
