# ============================================
# GitHubå®šæ—¶æé†’ç³»ç»Ÿ - æ¯3åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
# åŠŸèƒ½ï¼šåˆ°è¾¾æé†’æ—¥åï¼Œæ¯3åˆ†é’Ÿå‘é€ä¸€æ¬¡æé†’
# ä½œè€…ï¼šxiaowei1110000-cmyk
# ============================================

name: ğŸš€ è‡ªåŠ¨æé†’ç³»ç»Ÿ

# è§¦å‘æ¡ä»¶
on:
  # 1. æ¯3åˆ†é’Ÿè¿è¡Œä¸€æ¬¡
  schedule:
    - cron: '*/3 * * * *'     # æ¯3åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
  
  # 2. æ‰‹åŠ¨è§¦å‘ - ç”¨äºæµ‹è¯•
  workflow_dispatch:

# æƒé™è®¾ç½®
permissions:
  contents: write
  actions: read

# å…¨å±€ç¯å¢ƒå˜é‡
env:
  TZ: Asia/Shanghai
  NODE_VERSION: '18'

jobs:
  telegram-reminder:
    name: ğŸ“¨ å‘é€Telegramæé†’
    runs-on: ubuntu-latest
    
    steps:
      # æ­¥éª¤1: æ£€å‡ºä»£ç 
      - name: ğŸ“¥ 1. è·å–ä»£ç 
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      # æ­¥éª¤2: è®¾ç½®Node.js
      - name: ğŸ”§ 2. é…ç½®Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      # æ­¥éª¤3: å®‰è£…ä¾èµ–
      - name: ğŸ“¦ 3. å®‰è£…node-fetch
        run: npm install node-fetch@2
      
      # æ­¥éª¤4: æ‰§è¡Œæé†’è„šæœ¬
      - name: ğŸ¤– 4. æ‰§è¡Œæé†’æ£€æŸ¥
        id: reminder
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          echo "â° æ£€æŸ¥æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "ğŸ“… ä»Šæ—¥æ—¥æœŸ: $(TZ='Asia/Shanghai' date '+%Y-%m-%d')"
          
          # åˆ›å»ºå¹¶æ‰§è¡Œè„šæœ¬
          cat > reminder.js << 'EOF'
// ==================== æ¯3åˆ†é’Ÿæé†’ç³»ç»Ÿ ====================
const fs = require('fs');
const fetch = require('node-fetch');

// 1. è·å–åŒ—äº¬æ—¶é—´
function getBeijingDate() {
    const now = new Date();
    now.setHours(now.getHours() + 8);
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}

// 2. è·å–å½“å‰åŒ—äº¬æ—¶é—´ï¼ˆå®Œæ•´æ—¶é—´ï¼‰
function getBeijingTime() {
    const now = new Date();
    now.setHours(now.getHours() + 8);
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    const hours = String(now.getHours()).padStart(2, '0');
    const minutes = String(now.getMinutes()).padStart(2, '0');
    const seconds = String(now.getSeconds()).padStart(2, '0');
    return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
}

// 3. è®¡ç®—ä¸‹æ¬¡æé†’æ—¥æœŸ
function getNextDate(lastDate, days) {
    const date = new Date(lastDate);
    date.setDate(date.getDate() + days);
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}

// 4. ä¸»å‡½æ•°
async function main() {
    console.log('\n' + '='.repeat(60));
    console.log('ğŸš€ æ¯3åˆ†é’Ÿæé†’ç³»ç»Ÿ å¼€å§‹è¿è¡Œ');
    console.log('='.repeat(60));
    console.log(`â° å½“å‰æ—¶é—´: ${getBeijingTime()}`);
    
    // è¯»å–æ•°æ®
    let reminders = [];
    try {
        const data = fs.readFileSync('reminders.json', 'utf8');
        reminders = JSON.parse(data);
        console.log(`ğŸ“¦ åŠ è½½æé†’: ${reminders.length} ä¸ª`);
    } catch (e) {
        console.log('âŒ è¯»å–å¤±è´¥:', e.message);
        process.exit(1);
    }
    
    const today = getBeijingDate();
    console.log(`ğŸ“… ä»Šæ—¥æ—¥æœŸ: ${today}`);
    
    // æ‰¾å‡ºæ‰€æœ‰ä»Šæ—¥åˆ°æœŸçš„é¡¹ç›®ï¼ˆä¸ç®¡æ˜¯å¦å·²æé†’ï¼‰
    const dueList = reminders.filter(r => {
        return r.enabled !== false && r.nextReminder === today;
    });
    
    console.log(`ğŸ”” ä»Šæ—¥åˆ°æœŸ: ${dueList.length} ä¸ª`);
    
    // å¦‚æœæœ‰åˆ°æœŸé¡¹ç›®ï¼Œå‘é€æé†’
    if (dueList.length > 0) {
        const token = process.env.TELEGRAM_BOT_TOKEN;
        const chatId = process.env.TELEGRAM_CHAT_ID;
        
        if (!token || !chatId) {
            console.log('âŒ æœªé…ç½®Telegram Secrets');
            console.log('è¯·é…ç½®: TELEGRAM_BOT_TOKEN å’Œ TELEGRAM_CHAT_ID');
            process.exit(1);
        }
        
        // æ£€æŸ¥ä¸Šæ¬¡å‘é€æ—¶é—´ï¼Œé¿å…é‡å¤å‘é€å¤ªé¢‘ç¹
        const now = Date.now();
        const THREE_MINUTES = 3 * 60 * 1000; // 3åˆ†é’Ÿ
        
        // è¿‡æ»¤å‡ºéœ€è¦å‘é€çš„é¡¹ç›®ï¼ˆ3åˆ†é’Ÿå†…æœªå‘é€è¿‡çš„ï¼‰
        const needSendList = dueList.filter(item => {
            if (!item.lastReminderSent) return true;
            return (now - new Date(item.lastReminderSent).getTime()) > THREE_MINUTES;
        });
        
        if (needSendList.length === 0) {
            console.log('â„¹ï¸ æ‰€æœ‰é¡¹ç›®3åˆ†é’Ÿå†…å·²æé†’è¿‡ï¼Œè·³è¿‡æœ¬æ¬¡å‘é€');
            console.log('='.repeat(60));
            return;
        }
        
        console.log(`ğŸ“¤ éœ€è¦å‘é€: ${needSendList.length} ä¸ª`);
        
        // æ ¼å¼åŒ–æ¶ˆæ¯
        let msg = 'ğŸ”” *âš ï¸ ç´§æ€¥æé†’ï¼šé¡¹ç›®å·²åˆ°æœŸï¼*\n';
        msg += 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n';
        msg += `ğŸ“… æ—¥æœŸï¼š${today}\n`;
        msg += `â° æ—¶é—´ï¼š${new Date().toLocaleTimeString('zh-CN', {timeZone: 'Asia/Shanghai'})}\n`;
        msg += `â±ï¸ é¢‘ç‡ï¼šæ¯3åˆ†é’Ÿæé†’ä¸€æ¬¡\n\n`;
        msg += `*ä»Šæ—¥åˆ°æœŸé¡¹ç›®ï¼ˆ${dueList.length}é¡¹ï¼‰ï¼š*\n\n`;
        
        dueList.forEach((item, i) => {
            const nextDate = getNextDate(today, item.days);
            msg += `${i+1}. *${item.name}*\n`;
            msg += `   â€¢ æœ€åæ›´æ–°ï¼š${item.lastUpdated}\n`;
            msg += `   â€¢ çŠ¶æ€ï¼šâš ï¸ å·²åˆ°æœŸ\n`;
            msg += `   â€¢ å‘¨æœŸï¼šæ¯${item.days}å¤©\n`;
            msg += `   â€¢ ä¸‹æ¬¡æé†’ï¼š${nextDate}\n\n`;
            
            // æ›´æ–°å‘é€æ—¶é—´æˆ³ï¼ˆä½†ä¸æ›´æ–°æ—¥æœŸï¼Œå› ä¸ºè¿˜æ²¡å®Œæˆï¼‰
            item.lastReminderSent = new Date().toISOString();
            item.notified = false; // ä¿æŒæœªå®ŒæˆçŠ¶æ€ï¼Œç»§ç»­æé†’
        });
        
        msg += 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n';
        msg += 'ğŸ”„ *ç³»ç»Ÿå°†æ¯3åˆ†é’Ÿæé†’ä¸€æ¬¡ï¼Œç›´åˆ°æ‚¨å¤„ç†å®Œæˆ*\n';
        msg += 'âœ… *å¤„ç†å®Œæˆåï¼Œè¯·ç‚¹å‡»ä¸‹æ–¹é“¾æ¥æ‰‹åŠ¨æ›´æ–°çŠ¶æ€*\n\n';
        msg += `[âš™ï¸ ç‚¹å‡»è¿™é‡Œæ ‡è®°å·²å®Œæˆ]`;
        msg += `(https://${process.env.GITHUB_REPOSITORY}.github.io)`;
        
        // å‘é€Telegram
        console.log('ğŸ“¤ å‘é€Telegramæ¶ˆæ¯...');
        const url = `https://api.telegram.org/bot${token}/sendMessage`;
        
        try {
            const res = await fetch(url, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    chat_id: chatId,
                    text: msg,
                    parse_mode: 'Markdown',
                    disable_web_page_preview: false
                })
            });
            
            const result = await res.json();
            
            if (result.ok) {
                console.log(`âœ… å‘é€æˆåŠŸ: ${needSendList.length} æ¡æé†’`);
                // ä¿å­˜æ›´æ–°æ—¶é—´æˆ³
                fs.writeFileSync('reminders.json', JSON.stringify(reminders, null, 2));
                console.log('ğŸ’¾ å‘é€æ—¶é—´å·²è®°å½•');
            } else {
                console.log('âŒ å‘é€å¤±è´¥:', result.description);
            }
        } catch (error) {
            console.log('âŒ å‘é€å¼‚å¸¸:', error.message);
        }
    } else {
        console.log('â„¹ï¸ ä»Šæ—¥æ— åˆ°æœŸé¡¹ç›®');
    }
    
    console.log('='.repeat(60));
    console.log('âœ¨ æ£€æŸ¥å®Œæˆ');
    console.log('='.repeat(60));
}

main().catch(console.error);
EOF

          node reminder.js
      
      # æ­¥éª¤5: æäº¤æ›´æ–°ï¼ˆåªæ›´æ–°æ—¶é—´æˆ³ï¼Œä¸æ”¹å˜æé†’æ—¥æœŸï¼‰
      - name: ğŸ’¾ 5. ä¿å­˜å‘é€è®°å½•
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add reminders.json
          if git diff --staged --quiet; then
            echo "â„¹ï¸ æ— æ•°æ®æ›´æ–°"
          else
            git commit -m "â° è®°å½•æé†’å‘é€æ—¶é—´ [$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M')]"
            git push
            echo "âœ… å·²æäº¤å‘é€è®°å½•"
          fi
