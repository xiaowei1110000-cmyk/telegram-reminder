name: 定时提醒

on:
  schedule:
    # 每3分钟运行一次，24小时不间断
    - cron: '*/3 * * * *'
  workflow_dispatch:

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: 设置北京时间
        run: |
          sudo timedatectl set-timezone Asia/Shanghai
          echo "TZ='Asia/Shanghai'" >> $GITHUB_ENV
      
      - name: 检查并发送提醒
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          echo "=================================="
          echo "✅ 定时提醒系统启动"
          echo "⏰ 北京时间: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "=================================="
          
          # 检查文件
          if [ ! -f "reminders.json" ]; then
            echo "⚠️ 提醒文件不存在，创建默认文件"
            echo '[]' > reminders.json
          fi
          
          # 安装jq
          sudo apt-get update -qq && sudo apt-get install -y jq -qq
          
          # 今天日期
          TODAY=$(date '+%Y-%m-%d')
          echo "📅 今天: $TODAY"
          
          # 读取提醒
          COUNT=$(jq '. | length' reminders.json)
          echo "📋 共有 $COUNT 个提醒"
          
          SENT=0
          
          for i in $(seq 0 $((COUNT-1))); do
            NAME=$(jq -r ".[$i].name" reminders.json)
            NEXT=$(jq -r ".[$i].nextReminder" reminders.json)
            
            if [ "$NEXT" == "$TODAY" ]; then
              echo "⚠️ 到期: $NAME"
              
              if [ -n "$BOT_TOKEN" ] && [ -n "$CHAT_ID" ]; then
                curl -s -X POST \
                  "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
                  -d "chat_id=${CHAT_ID}" \
                  -d "text=🔔 定时提醒%0A%0A📌 名称：${NAME}%0A📅 日期：${TODAY}" \
                  -d "parse_mode=HTML" > /dev/null
                
                if [ $? -eq 0 ]; then
                  echo "✅ 发送成功"
                  SENT=$((SENT+1))
                fi
              fi
            fi
          done
          
          echo "📊 本次发送: $SENT 条"
          echo "=================================="
