# ============================================
# å®šæ—¶æé†’ç³»ç»Ÿ - ä¸»å·¥ä½œæµæ–‡ä»¶
# ä½ç½®ï¼š.github/workflows/send-reminder.yml
# åŠŸèƒ½ï¼šæ¯3åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡ï¼Œåˆ°æœŸè‡ªåŠ¨å‘é€Telegram
# ============================================

name: å®šæ—¶æé†’ç³»ç»Ÿ

# è§¦å‘æ¡ä»¶
on:
  # 1. å®šæ—¶è§¦å‘ï¼šæ¯3åˆ†é’Ÿè¿è¡Œä¸€æ¬¡
  schedule:
    - cron: '*/3 * * * *'
  
  # 2. æ‰‹åŠ¨è§¦å‘ï¼šç”¨äºæµ‹è¯•
  workflow_dispatch:
    inputs:
      reason:
        description: 'è§¦å‘åŸå› '
        required: false
        default: 'æ‰‹åŠ¨æµ‹è¯•'

# æƒé™è®¾ç½®
permissions:
  contents: write  # å…è®¸å†™å…¥ä»“åº“

jobs:
  check-and-send:
    name: æ£€æŸ¥å¹¶å‘é€æé†’
    runs-on: ubuntu-latest
    
    steps:
      # æ­¥éª¤1ï¼šè·å–ä»£ç 
      - name: ğŸ“¥ ä¸‹è½½ä»£ç 
        uses: actions/checkout@v3
        with:
          fetch-depth: 1
          token: ${{ secrets.GITHUB_TOKEN }}
      
      # æ­¥éª¤2ï¼šè®¾ç½®Node.js
      - name: ğŸ”§ è®¾ç½®Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      # æ­¥éª¤3ï¼šå®‰è£…ä¾èµ–
      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: |
          npm init -y
          npm install node-fetch@2
      
      # æ­¥éª¤4ï¼šæ‰§è¡Œæé†’è„šæœ¬
      - name: ğŸ¤– æ‰§è¡Œæé†’æ£€æŸ¥
        id: reminder
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          echo "â° å¼€å§‹æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "ğŸ“… åŒ—äº¬æ—¶é—´: $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')"
          
          # ==================== æ ¸å¿ƒè„šæœ¬ ====================
          cat > reminder.js << 'NODE_SCRIPT'
const fs = require('fs');
const https = require('https');

// ---------- æ—¥æœŸå·¥å…·å‡½æ•° ----------
function getBeijingDate() {
    const now = new Date();
    now.setHours(now.getHours() + 8);
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}

function getBeijingTime() {
    const now = new Date();
    now.setHours(now.getHours() + 8);
    return now.toLocaleString('zh-CN', { hour12: false });
}

function getNextDate(dateStr, days) {
    const date = new Date(dateStr);
    date.setDate(date.getDate() + days);
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}

// ---------- ä¸»å‡½æ•° ----------
async function main() {
    console.log('='.repeat(60));
    console.log('ğŸš€ å®šæ—¶æé†’ç³»ç»Ÿå¯åŠ¨');
    console.log('='.repeat(60));
    
    // 1. è·å–é…ç½®
    const token = process.env.TELEGRAM_BOT_TOKEN;
    const chatId = process.env.TELEGRAM_CHAT_ID;
    
    if (!token || !chatId) {
        console.log('âŒ é”™è¯¯ï¼šæœªé…ç½®Telegram Secrets');
        console.log('   è¯·åœ¨ä»“åº“ Settings â†’ Secrets æ·»åŠ ï¼š');
        console.log('   - TELEGRAM_BOT_TOKEN');
        console.log('   - TELEGRAM_CHAT_ID');
        process.exit(1);
    }
    console.log('âœ… Telegramé…ç½®æ­£å¸¸');
    
    // 2. è¯»å–æé†’æ•°æ®
    let reminders = [];
    try {
        const data = fs.readFileSync('reminders.json', 'utf8');
        reminders = JSON.parse(data);
        console.log(`ğŸ“¦ åŠ è½½æé†’: ${reminders.length} ä¸ª`);
    } catch (error) {
        console.log('âš ï¸ æœªæ‰¾åˆ°reminders.jsonï¼Œåˆ›å»ºé»˜è®¤æ•°æ®');
        reminders = [{
            id: Date.now(),
            name: 'ç¤ºä¾‹æé†’',
            lastUpdated: getBeijingDate(),
            nextReminder: getBeijingDate(),
            days: 1,
            enabled: true,
            notified: false,
            createdAt: new Date().toISOString()
        }];
        fs.writeFileSync('reminders.json', JSON.stringify(reminders, null, 2));
    }
    
    // 3. è·å–ä»Šæ—¥æ—¥æœŸ
    const today = getBeijingDate();
    console.log(`ğŸ“… ä»Šæ—¥æ—¥æœŸ: ${today}`);
    
    // 4. æ‰¾å‡ºä»Šæ—¥åˆ°æœŸä¸”æœªå®Œæˆçš„é¡¹ç›®
    const dueReminders = reminders.filter(r => {
        return r.enabled !== false && 
               r.nextReminder === today;
    });
    
    console.log(`ğŸ”” ä»Šæ—¥åˆ°æœŸ: ${dueReminders.length} ä¸ª`);
    
    // 5. å¦‚æœæœ‰åˆ°æœŸé¡¹ç›®ï¼Œå‘é€æé†’
    if (dueReminders.length > 0) {
        // æ£€æŸ¥3åˆ†é’Ÿå†…æ˜¯å¦å‘é€è¿‡
        const now = Date.now();
        const THREE_MINUTES = 3 * 60 * 1000;
        
        const needSend = dueReminders.filter(r => {
            if (!r.lastSentTime) return true;
            return now - new Date(r.lastSentTime).getTime() > THREE_MINUTES;
        });
        
        if (needSend.length === 0) {
            console.log('â¸ï¸ æ‰€æœ‰é¡¹ç›®3åˆ†é’Ÿå†…å·²æé†’è¿‡ï¼Œè·³è¿‡æœ¬æ¬¡');
            console.log('='.repeat(60));
            return;
        }
        
        console.log(`ğŸ“¤ æœ¬æ¬¡å‘é€: ${needSend.length} ä¸ª`);
        
        // æ ¼å¼åŒ–æ¶ˆæ¯
        let message = 'ğŸ”” *å®šæ—¶æé†’ç³»ç»Ÿ - åˆ°æœŸé€šçŸ¥*\n';
        message += 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n';
        message += `ğŸ“… æ—¥æœŸï¼š${today}\n`;
        message += `â° æ—¶é—´ï¼š${getBeijingTime()}\n`;
        message += `â±ï¸ é¢‘ç‡ï¼šæ¯3åˆ†é’Ÿæé†’ä¸€æ¬¡\n\n`;
        message += `*ä»Šæ—¥åˆ°æœŸé¡¹ç›®ï¼š*\n\n`;
        
        dueReminders.forEach((item, index) => {
            const nextDate = getNextDate(today, item.days);
            message += `${index + 1}. *${item.name}*\n`;
            message += `   â€¢ å‘¨æœŸï¼šæ¯ ${item.days} å¤©\n`;
            message += `   â€¢ æœ€åæ›´æ–°ï¼š${item.lastUpdated}\n`;
            message += `   â€¢ ä¸‹æ¬¡æé†’ï¼š${nextDate}\n`;
            message += `   â€¢ çŠ¶æ€ï¼šâš ï¸ ç­‰å¾…å¤„ç†\n\n`;
            
            // æ›´æ–°å‘é€æ—¶é—´
            item.lastSentTime = new Date().toISOString();
            item.notified = false;  // ä¿æŒæœªå®ŒæˆçŠ¶æ€
        });
        
        message += 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n';
        message += 'âœ… *å¤„ç†å®Œæˆåï¼Œè¯·ç‚¹å‡»ä¸‹æ–¹é“¾æ¥æ›´æ–°çŠ¶æ€ï¼š*\n';
        message += `[âš™ï¸ ç‚¹å‡»è¿™é‡Œæ ‡è®°å·²å®Œæˆ]`;
        message += `(https://github.com/${process.env.GITHUB_REPOSITORY}/blob/main/README.md)\n\n`;
        message += 'ğŸ”„ ç³»ç»Ÿå°†æŒç»­æé†’ï¼Œç›´åˆ°æ‚¨å¤„ç†å®Œæˆ';
        
        // å‘é€åˆ°Telegram
        const url = `https://api.telegram.org/bot${token}/sendMessage`;
        const postData = JSON.stringify({
            chat_id: chatId,
            text: message,
            parse_mode: 'Markdown',
            disable_web_page_preview: false
        });
        
        try {
            const response = await new Promise((resolve, reject) => {
                const req = https.request(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Content-Length': Buffer.byteLength(postData)
                    }
                }, (res) => {
                    let data = '';
                    res.on('data', chunk => data += chunk);
                    res.on('end', () => {
                        try {
                            resolve(JSON.parse(data));
                        } catch (e) {
                            reject(e);
                        }
                    });
                });
                
                req.on('error', reject);
                req.write(postData);
                req.end();
            });
            
            if (response.ok) {
                console.log(`âœ… å‘é€æˆåŠŸ: ${needSend.length} æ¡`);
                // ä¿å­˜æ›´æ–°æ—¶é—´æˆ³
                fs.writeFileSync('reminders.json', JSON.stringify(reminders, null, 2));
                console.log('ğŸ’¾ å‘é€æ—¶é—´å·²è®°å½•');
            } else {
                console.log(`âŒ å‘é€å¤±è´¥: ${response.description}`);
            }
        } catch (error) {
            console.log(`âŒ è¯·æ±‚å¤±è´¥: ${error.message}`);
        }
    } else {
        console.log('â„¹ï¸ ä»Šæ—¥æ— åˆ°æœŸé¡¹ç›®');
    }
    
    console.log('='.repeat(60));
    console.log('âœ¨ æ£€æŸ¥å®Œæˆ');
    console.log('='.repeat(60));
}

// æ‰§è¡Œä¸»å‡½æ•°
main().catch(error => {
    console.error('âŒ ç¨‹åºé”™è¯¯:', error.message);
    process.exit(1);
});
NODE_SCRIPT

          # æ‰§è¡Œè„šæœ¬
          node reminder.js
      
      # æ­¥éª¤5ï¼šæäº¤æ›´æ–°
      - name: ğŸ’¾ ä¿å­˜æ›´æ”¹
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add reminders.json
          if git diff --staged --quiet; then
            echo "â„¹ï¸ æ²¡æœ‰æ•°æ®æ›´æ–°"
          else
            git commit -m "ğŸ“… è‡ªåŠ¨æ›´æ–°å‘é€æ—¶é—´ [$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M')]"
            git push
            echo "âœ… å·²æäº¤æ›´æ–°"
          fi
