name: å®šæ—¶æé†’ç³»ç»Ÿ

on:
  schedule:
    - cron: '*/3 * * * *'   # æ¯3åˆ†é’Ÿ
  workflow_dispatch:
  repository_dispatch:
    types: [ping]

jobs:
  reminder:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # é‡è¦ï¼šå…è®¸å†™å…¥ä»£ç 
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 1
          
      - name: â° è®¾ç½®åŒ—äº¬æ—¶é—´
        run: |
          sudo timedatectl set-timezone Asia/Shanghai
          echo "âœ… å½“å‰æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          
      - name: ğŸ” æ£€æŸ¥å¹¶å‘é€æé†’
        id: check
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          echo "========================================="
          echo "ğŸš€ å®šæ—¶æé†’ç³»ç»Ÿå¯åŠ¨"
          echo "â° åŒ—äº¬æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "ğŸ¯ è§¦å‘æ–¹å¼: ${{ github.event_name }}"
          echo "========================================="
          
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ ! -f "reminders.json" ]; then
            echo "âŒ reminders.json ä¸å­˜åœ¨"
            echo '[]' > reminders.json
          fi
          
          # å®‰è£… jq
          sudo apt-get update -qq && sudo apt-get install -y jq -qq
          
          # ä»Šå¤©æ—¥æœŸ
          TODAY=$(date '+%Y-%m-%d')
          echo "ğŸ“… ä»Šå¤©æ—¥æœŸ: $TODAY"
          
          # è¯»å–æé†’æ•°é‡
          COUNT=$(jq '. | length' reminders.json)
          echo "ğŸ“‹ å…±æœ‰ $COUNT ä¸ªæé†’"
          
          SENT=0
          UPDATED=0
          
          # åˆ›å»ºä¸´æ—¶æ–‡ä»¶
          cp reminders.json reminders.json.bak
          
          # éå†æ‰€æœ‰æé†’
          for i in $(seq 0 $((COUNT-1))); do
            NAME=$(jq -r ".[$i].name" reminders.json)
            NEXT=$(jq -r ".[$i].nextReminder" reminders.json)
            DAYS=$(jq -r ".[$i].days" reminders.json)
            NOTIFIED=$(jq -r ".[$i].notified // false" reminders.json)
            
            echo "------------------------"
            echo "ğŸ“Œ æ£€æŸ¥: $NAME"
            echo "ğŸ“… ä¸‹æ¬¡æé†’: $NEXT"
            echo "â° é—´éš”: $DAYS å¤©"
            echo "ğŸ“ å·²é€šçŸ¥: $NOTIFIED"
            
            # æƒ…å†µ1ï¼šä»Šå¤©åˆ°æœŸä¸”æœªé€šçŸ¥ â†’ å‘é€æé†’
            if [ "$NEXT" == "$TODAY" ] && [ "$NOTIFIED" == "false" ]; then
              echo "âš ï¸ ä»Šæ—¥åˆ°æœŸï¼å‘é€Telegramæé†’..."
              
              if [ -n "$TELEGRAM_BOT_TOKEN" ] && [ -n "$TELEGRAM_CHAT_ID" ]; then
                MESSAGE="ğŸ”” <b>å®šæ—¶æé†’</b>%0A%0AğŸ“Œ <b>åç§°ï¼š</b>${NAME}%0AğŸ“… <b>æé†’æ—¥æœŸï¼š</b>${TODAY}%0Aâ° <b>é—´éš”ï¼š</b>${DAYS}å¤©%0A%0Aè¯·åŠæ—¶å¤„ç†ï¼"
                
                RESPONSE=$(curl -s -X POST \
                  "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
                  -d "chat_id=${TELEGRAM_CHAT_ID}" \
                  -d "text=${MESSAGE}" \
                  -d "parse_mode=HTML")
                
                if echo "$RESPONSE" | grep -q '"ok":true'; then
                  echo "âœ… æé†’å‘é€æˆåŠŸ"
                  SENT=$((SENT+1))
                  
                  # æ ‡è®°ä¸ºå·²é€šçŸ¥
                  jq ".[$i].notified = true" reminders.json > tmp.json && mv tmp.json reminders.json
                  jq ".[$i].lastSentTime = \"$(date -Iseconds)\"" reminders.json > tmp.json && mv tmp.json reminders.json
                else
                  echo "âŒ å‘é€å¤±è´¥: $RESPONSE"
                fi
              fi
            fi
            
            # æƒ…å†µ2ï¼šå·²é€šçŸ¥è¿‡ â†’ æ›´æ–°åˆ°ä¸‹ä¸€ä¸ªå‘¨æœŸ
            if [ "$NOTIFIED" == "true" ]; then
              echo "ğŸ”„ å·²å‘é€è¿‡ï¼Œæ›´æ–°åˆ°ä¸‹ä¸€ä¸ªå‘¨æœŸ..."
              
              # è®¡ç®—ä¸‹æ¬¡æé†’æ—¥æœŸ
              CURRENT_DATE=$(date -d "$TODAY" '+%s')
              NEXT_DATE=$((CURRENT_DATE + DAYS * 86400))
              NEXT_REMINDER=$(date -d "@$NEXT_DATE" '+%Y-%m-%d')
              
              # æ›´æ–°å­—æ®µ
              jq ".[$i].lastUpdated = \"$TODAY\"" reminders.json > tmp.json && mv tmp.json reminders.json
              jq ".[$i].nextReminder = \"$NEXT_REMINDER\"" reminders.json > tmp.json && mv tmp.json reminders.json
              jq ".[$i].notified = false" reminders.json > tmp.json && mv tmp.json reminders.json
              
              echo "âœ… å·²æ›´æ–°: $NAME -> $NEXT_REMINDER"
              UPDATED=$((UPDATED+1))
            fi
          done
          
          echo "------------------------"
          echo "ğŸ“Š ç»Ÿè®¡ä¿¡æ¯"
          echo "   â€¢ å‘é€æé†’: $SENT æ¡"
          echo "   â€¢ æ›´æ–°å‘¨æœŸ: $UPDATED ä¸ª"
          
          # æ¯”è¾ƒæ–‡ä»¶æ˜¯å¦æœ‰å˜åŒ–
          if ! cmp -s reminders.json reminders.json.bak; then
            echo "ğŸ”„ æ£€æµ‹åˆ°æ•°æ®å˜æ›´ï¼Œå‡†å¤‡æäº¤åˆ°GitHub..."
            
            git config --global user.name "Reminder Bot"
            git config --global user.email "reminder@bot.com"
            
            git add reminders.json
            git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–°æé†’æ•°æ® [$(date '+%Y-%m-%d %H:%M')]"
            
            # æœ€å¤šé‡è¯•3æ¬¡
            for retry in 1 2 3; do
              echo "â³ æ¨é€å°è¯• $retry/3..."
              if git pull --rebase origin main && git push; then
                echo "âœ… æ¨é€æˆåŠŸ"
                break
              else
                echo "âŒ æ¨é€å¤±è´¥ï¼Œ5ç§’åé‡è¯•..."
                sleep 5
              fi
            done
          else
            echo "â„¹ï¸ æ•°æ®æ— å˜åŒ–ï¼Œæ— éœ€æäº¤"
          fi
          
          rm -f reminders.json.bak tmp.json
          echo "========================================="
          echo "âœ¨ æ‰§è¡Œå®Œæˆ"
          echo "========================================="
