name: å®šæ—¶æé†’ç³»ç»Ÿ

on:
  schedule:
    # æ¯3åˆ†é’Ÿè¿è¡Œä¸€æ¬¡
    - cron: '*/3 * * * *'
  workflow_dispatch:

jobs:
  send-reminder:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v3
        
      - name: å‘é€Telegramæé†’
        env:
          TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          echo "==================================="
          echo "ğŸš€ å®šæ—¶æé†’ç³»ç»Ÿå¼€å§‹è¿è¡Œ"
          echo "==================================="
          echo "â° å½“å‰æ—¶é—´: $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')"
          echo "ğŸ”” è§¦å‘æ–¹å¼: ${{ github.event_name }}"
          echo ""
          
          # 1. è¯»å–æé†’æ•°æ®
          if [ -f "reminders.json" ]; then
            echo "ğŸ“¦ æ‰¾åˆ°æé†’æ•°æ®æ–‡ä»¶"
            cat reminders.json
          else
            echo "ğŸ“ æé†’æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè·³è¿‡"
            exit 0
          fi
          
          # 2. ä½¿ç”¨Node.jså¤„ç†æé†’
          node << 'EOF'
          const fs = require('fs');
          const https = require('https');

          // åŒ—äº¬æ—¶é—´
          const now = new Date();
          now.setHours(now.getHours() + 8);
          const today = now.toISOString().split('T')[0];
          
          console.log(`ğŸ“… ä»Šæ—¥æ—¥æœŸ: ${today}`);
          
          // è¯»å–æé†’
          let reminders = [];
          try {
            reminders = JSON.parse(fs.readFileSync('reminders.json'));
            console.log(`ğŸ“‹ æ€»æé†’æ•°: ${reminders.length}`);
          } catch (e) {
            console.log('âŒ è¯»å–å¤±è´¥');
            process.exit(0);
          }
          
          // æ‰¾å‡ºä»Šæ—¥åˆ°æœŸ
          const dueList = reminders.filter(r => 
            r.enabled !== false && r.nextReminder === today
          );
          
          console.log(`ğŸ”” ä»Šæ—¥åˆ°æœŸ: ${dueList.length}ä¸ª`);
          
          if (dueList.length === 0) {
            console.log('â„¹ï¸ ä»Šæ—¥æ— åˆ°æœŸæé†’');
            process.exit(0);
          }
          
          // å‘é€Telegram
          const token = process.env.TOKEN;
          const chatId = process.env.CHAT_ID;
          
          let message = 'ğŸ”” *å®šæ—¶æé†’ç³»ç»Ÿ*\n';
          message += 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n';
          message += `â° æ—¶é—´: ${new Date().toLocaleString('zh-CN', {timeZone: 'Asia/Shanghai'})}\n`;
          message += `ğŸ“… åˆ°æœŸ: ${dueList.length}ä¸ªé¡¹ç›®\n\n`;
          
          dueList.forEach((item, i) => {
            message += `${i+1}. *${item.name}*\n`;
            message += `   å‘¨æœŸ: ${item.days}å¤©\n`;
            
            // è®¡ç®—ä¸‹æ¬¡æé†’
            const next = new Date(today);
            next.setDate(next.getDate() + item.days);
            const nextStr = next.toISOString().split('T')[0];
            message += `   ä¸‹æ¬¡: ${nextStr}\n\n`;
            
            // æ›´æ–°æ•°æ®
            item.lastUpdated = today;
            item.nextReminder = nextStr;
            item.notified = true;
            item.lastSentTime = new Date().toISOString();
          });
          
          message += 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n';
          message += 'âœ… å¤„ç†å®Œæˆåè¯·ç™»å½•ç½‘é¡µæ›´æ–°çŠ¶æ€';
          
          const url = `https://api.telegram.org/bot${token}/sendMessage`;
          const data = JSON.stringify({
            chat_id: chatId,
            text: message,
            parse_mode: 'Markdown'
          });
          
          const req = https.request(url, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Content-Length': Buffer.byteLength(data)
            }
          }, (res) => {
            let resp = '';
            res.on('data', chunk => resp += chunk);
            res.on('end', () => {
              const result = JSON.parse(resp);
              if (result.ok) {
                console.log('âœ… å‘é€æˆåŠŸ');
                fs.writeFileSync('reminders.json', JSON.stringify(reminders, null, 2));
                console.log('ğŸ’¾ æ•°æ®å·²æ›´æ–°');
              }
            });
          });
          
          req.on('error', (e) => console.log('âŒ å‘é€å¤±è´¥:', e.message));
          req.write(data);
          req.end();
          
          EOF
          
      - name: æäº¤æ›´æ–°
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add reminders.json
          git diff --quiet && git diff --staged --quiet || git commit -m "ğŸ“… è‡ªåŠ¨æ›´æ–°æé†’çŠ¶æ€"
          git push
