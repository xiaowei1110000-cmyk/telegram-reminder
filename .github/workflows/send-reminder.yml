name: 定时提醒系统

on:
  schedule:
    - cron: '0 3 * * *'   # UTC 3:00 = 北京时间 11:00
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'reminders.json'

jobs:
  reminder:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: 检出代码
        uses: actions/checkout@v3
          
      - name: 设置北京时间
        run: |
          sudo timedatectl set-timezone Asia/Shanghai
          echo "TODAY=$(date '+%Y-%m-%d')" >> $GITHUB_ENV
          
      - name: 检查并发送提醒
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          echo "========== 定时提醒系统 =========="
          echo "时间: $(date '+%Y-%m-%d %H:%M:%S')"
          
          # 安装 jq
          sudo apt-get update -qq && sudo apt-get install -y jq -qq
          
          TODAY="${{ env.TODAY }}"
          echo "今天日期: $TODAY"
          
          # 检查文件
          if [ ! -f "reminders.json" ]; then
            echo "错误: reminders.json 不存在"
            exit 1
          fi
          
          # 显示文件内容（调试用）
          echo "文件内容:"
          cat reminders.json
          echo ""
          
          # 读取提醒数量
          COUNT=$(jq '. | length' reminders.json 2>/dev/null || echo "0")
          if [ "$COUNT" == "0" ]; then
            echo "没有提醒项目或文件为空"
            exit 0
          fi
          
          echo "共有 $COUNT 个提醒项目"
          
          # 收集今天到期的项目
          DUE_ITEMS=""
          DUE_NAMES=""
          DUE_LAST=""
          DUE_DAYS=""
          DUE_NEXT=""
          FIRST_ITEM=true
          UPDATED=false
          
          # 遍历检查
          for i in $(seq 0 $((COUNT-1))); do
            # 使用临时文件避免管道错误
            NAME=$(jq -r ".[$i].name // empty" reminders.json 2>/dev/null)
            NEXT=$(jq -r ".[$i].nextReminder // empty" reminders.json 2>/dev/null)
            DAYS=$(jq -r ".[$i].days // 0" reminders.json 2>/dev/null)
            LAST=$(jq -r ".[$i].lastUpdated // empty" reminders.json 2>/dev/null)
            NOTIFIED=$(jq -r ".[$i].notified // false" reminders.json 2>/dev/null)
            
            # 跳过空项目
            if [ -z "$NAME" ] || [ -z "$NEXT" ]; then
              continue
            fi
            
            echo ""
            echo "检查项目: $NAME"
            echo "  下次提醒: $NEXT"
            echo "  通知状态: $NOTIFIED"
            
            if [ "$NEXT" == "$TODAY" ]; then
              echo "  ✅ 今天到期"
              
              # 收集项目名称
              DUE_ITEMS="${DUE_ITEMS}    $(( $(echo "$DUE_ITEMS" | wc -l) + 1 )). ${NAME}\n"
              
              # 如果是第一个到期项目，保存共用信息
              if [ "$FIRST_ITEM" == "true" ]; then
                DUE_LAST="$LAST"
                DUE_DAYS="$DAYS"
                # 计算下次提醒
                DUE_NEXT=$(date -d "$TODAY + $DAYS days" '+%Y-%m-%d' 2>/dev/null || echo "$TODAY")
                FIRST_ITEM=false
              fi
              
              # 更新日期和通知状态
              if [ "$NOTIFIED" == "false" ]; then
                NEXT_DATE=$(date -d "$TODAY + $DAYS days" '+%Y-%m-%d' 2>/dev/null || echo "$TODAY")
                
                # 创建临时文件更新 JSON
                jq ".[$i].lastUpdated = \"$TODAY\"" reminders.json > tmp1.json
                jq ".[$i].nextReminder = \"$NEXT_DATE\"" tmp1.json > tmp2.json
                jq ".[$i].notified = true" tmp2.json > tmp3.json
                jq ".[$i].lastSentTime = \"$(date -Iseconds)\"" tmp3.json > reminders.json
                rm -f tmp1.json tmp2.json tmp3.json
                
                UPDATED=true
                echo "  ✅ 已更新"
              else
                echo "  ⏸️ 今天已通知过"
              fi
            fi
          done
          
          # 如果有到期项目，发送合并提醒
          if [ -n "$DUE_ITEMS" ]; then
            echo ""
            echo "发送合并提醒..."
            
            # 构建消息
            MESSAGE="╔════════════════════════════╗%0A"
            MESSAGE="${MESSAGE}║  🔔 到期事务提醒%0A"
            MESSAGE="${MESSAGE}╚════════════════════════════╝%0A%0A"
            MESSAGE="${MESSAGE}📌 今日需要处理项目%0A"
            MESSAGE="${MESSAGE}${DUE_ITEMS}%0A"
            MESSAGE="${MESSAGE}├─ 上次更新: ${DUE_LAST:-未知}%0A"
            MESSAGE="${MESSAGE}├─ 本次提醒: 今天 ${TODAY}%0A"
            MESSAGE="${MESSAGE}├─ 间隔周期: ${DUE_DAYS:-0} 天%0A"
            MESSAGE="${MESSAGE}└─ 下次提醒: ${DUE_NEXT:-${TODAY}}%0A%0A"
            MESSAGE="${MESSAGE}⚡️ 请及时处理"
            
            # 发送 Telegram
            RESPONSE=$(curl -s -X POST \
              "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              -d "chat_id=${TELEGRAM_CHAT_ID}" \
              -d "text=${MESSAGE}" \
              -d "parse_mode=HTML")
            
            if echo "$RESPONSE" | grep -q '"ok":true'; then
              echo "✅ 合并提醒发送成功"
            else
              echo "❌ 发送失败: $RESPONSE"
            fi
          else
            echo ""
            echo "ℹ️ 今天没有到期项目"
          fi
          
          # 如果有更新，提交到 GitHub
          if [ "$UPDATED" == "true" ]; then
            echo ""
            echo "提交更新到 GitHub..."
            
            git config --global user.name "Reminder Bot"
            git config --global user.email "reminder-bot@users.noreply.github.com"
            
            git add reminders.json
            git commit -m "自动更新提醒日期 $(date '+%Y-%m-%d %H:%M')" || true
            git push
            
            echo "✅ 更新完成"
          fi
          
          echo ""
          echo "========== 完成 =========="
