name: å®šæ—¶æé†’ç³»ç»Ÿ

on:
  schedule:
    - cron: '0 3 * * *'
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'reminders.json'

jobs:
  reminder:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v3
          
      - name: è®¾ç½®åŒ—äº¬æ—¶é—´
        run: |
          sudo timedatectl set-timezone Asia/Shanghai
          echo "TODAY=$(date '+%Y-%m-%d')" >> $GITHUB_ENV
          
      - name: æ£€æŸ¥å¹¶å‘é€æé†’
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          echo "========== å®šæ—¶æé†’ç³»ç»Ÿ =========="
          echo "æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          
          # å®‰è£… jq
          sudo apt-get update -qq && sudo apt-get install -y jq -qq
          
          TODAY="${{ env.TODAY }}"
          echo "ä»Šå¤©æ—¥æœŸ: $TODAY"
          
          # æ£€æŸ¥æ–‡ä»¶
          if [ ! -f "reminders.json" ]; then
            echo "é”™è¯¯: reminders.json ä¸å­˜åœ¨"
            exit 1
          fi
          
          # è¯»å–æé†’
          COUNT=$(jq '. | length' reminders.json)
          echo "å…±æœ‰ $COUNT ä¸ªæé†’é¡¹ç›®"
          
          # éå†æ£€æŸ¥
          for i in $(seq 0 $((COUNT-1))); do
            NAME=$(jq -r ".[$i].name" reminders.json)
            NEXT=$(jq -r ".[$i].nextReminder" reminders.json)
            DAYS=$(jq -r ".[$i].days" reminders.json)
            LAST=$(jq -r ".[$i].lastUpdated" reminders.json)
            
            if [ "$NEXT" == "$TODAY" ]; then
              echo ""
              echo "åˆ°æœŸé¡¹ç›®: $NAME"
              
              # è®¡ç®—ä¸‹æ¬¡æé†’
              NEXT_DATE=$(date -d "$TODAY + $DAYS days" '+%Y-%m-%d')
              
              # å‘é€ Telegram
              MESSAGE="ğŸ”” åˆ°æœŸæé†’%0A%0A"
              MESSAGE="${MESSAGE}é¡¹ç›®: ${NAME}%0A"
              MESSAGE="${MESSAGE}ä¸Šæ¬¡æ›´æ–°: ${LAST}%0A"
              MESSAGE="${MESSAGE}æœ¬æ¬¡æé†’: ä»Šå¤© ${TODAY}%0A"
              MESSAGE="${MESSAGE}ä¸‹æ¬¡æé†’: ${NEXT_DATE}"
              
              curl -s -X POST \
                "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
                -d "chat_id=${TELEGRAM_CHAT_ID}" \
                -d "text=${MESSAGE}" > /dev/null
              
              echo "å·²å‘é€æé†’"
              
              # æ›´æ–°æ—¥æœŸ
              jq ".[$i].lastUpdated = \"$TODAY\"" reminders.json > tmp.json
              jq ".[$i].nextReminder = \"$NEXT_DATE\"" tmp.json > reminders.json
              rm tmp.json
            fi
          done
          
          echo ""
          echo "========== å®Œæˆ =========="
