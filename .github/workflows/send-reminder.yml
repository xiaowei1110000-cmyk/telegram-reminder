name: 定时提醒系统

on:
  schedule:
    - cron: '*/3 * * * *'   # 每3分钟自动运行，无需手动触发
  workflow_dispatch:         # 手动触发作为备选

jobs:
  reminder:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: 📥 检出代码
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: ⏰ 设置北京时间
        run: |
          sudo timedatectl set-timezone Asia/Shanghai
          echo "TODAY=$(date '+%Y-%m-%d')" >> $GITHUB_ENV
          echo "CURRENT_TIME=$(date '+%H:%M:%S')" >> $GITHUB_ENV
          
      - name: 🤖 自动检查并发送提醒
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          echo "========================================="
          echo "🚀 定时提醒系统自动启动"
          echo "⏰ 北京时间: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "========================================="
          
          # 检查提醒文件
          if [ ! -f "reminders.json" ]; then
            echo "❌ reminders.json 不存在"
            exit 0
          fi
          
          # 安装 jq
          sudo apt-get update -qq && sudo apt-get install -y jq -qq
          
          TODAY="${{ env.TODAY }}"
          echo "📅 今天日期: $TODAY"
          
          # 读取提醒数量
          COUNT=$(jq '. | length' reminders.json)
          echo "📋 共有 $COUNT 个提醒"
          echo ""
          
          SENT=0
          UPDATED=0
          DUE_ITEMS=""
          INDEX=1
          
          # 遍历所有提醒
          for i in $(seq 0 $((COUNT-1))); do
            NAME=$(jq -r ".[$i].name" reminders.json)
            NEXT=$(jq -r ".[$i].nextReminder" reminders.json)
            DAYS=$(jq -r ".[$i].days" reminders.json)
            LAST=$(jq -r ".[$i].lastUpdated // \"未知\"" reminders.json)
            NOTIFIED=$(jq -r ".[$i].notified // false" reminders.json)
            
            # 如果今天到期
            if [ "$NEXT" == "$TODAY" ]; then
              echo "⚠️ 到期提醒: $NAME"
              
              # 添加到到期列表
              DUE_ITEMS="${DUE_ITEMS}├─ 到期项目: $NAME\n"
              
              # 如果未发送过提醒
              if [ "$NOTIFIED" == "false" ]; then
                echo "📤 准备发送Telegram提醒..."
                
                # 计算明天日期
                TOMORROW=$(date -d "$TODAY + 1 day" '+%Y-%m-%d')
                
                # 构建Telegram消息 - 您想要的完美格式
                MESSAGE="╔════════════════════════════╗%0A║  🔔 重要事务提醒 %0A╚════════════════════════════╝%0A%0A"
                MESSAGE="${MESSAGE}┌─[ #${INDEX} ${NAME} ]%0A"
                MESSAGE="${MESSAGE}│  📅 上次更新 · ⚪️ ${LAST}%0A"
                MESSAGE="${MESSAGE}│  ⏰ 提醒时间 · 🔴 今天%0A"
                MESSAGE="${MESSAGE}│  📊 间隔周期 · ${DAYS}天%0A"
                MESSAGE="${MESSAGE}│  ⏩ 下次提醒 · 🔴 🟡 ${TOMORROW}%0A"
                MESSAGE="${MESSAGE}│  ⏱️ 剩余时间 · ⚠️ 今日到期%0A"
                MESSAGE="${MESSAGE}└⋯⋯⋯⋯⋯⋯⋯⋯⋯⋯⋯⋯⋯⋯┘%0A%0A"
                
                # 发送Telegram
                RESPONSE=$(curl -s -X POST \
                  "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
                  -d "chat_id=${TELEGRAM_CHAT_ID}" \
                  -d "text=${MESSAGE}" \
                  -d "parse_mode=HTML")
                
                if echo "$RESPONSE" | grep -q '"ok":true'; then
                  echo "✅ Telegram发送成功"
                  SENT=$((SENT+1))
                  
                  # 计算下次提醒日期
                  NEXT_DATE=$(date -d "$TODAY + $DAYS days" '+%Y-%m-%d')
                  
                  # 更新JSON - 自动设置下次提醒日期
                  jq ".[$i].lastUpdated = \"$TODAY\"" reminders.json > tmp.json && mv tmp.json reminders.json
                  jq ".[$i].nextReminder = \"$NEXT_DATE\"" reminders.json > tmp.json && mv tmp.json reminders.json
                  jq ".[$i].notified = true" reminders.json > tmp.json && mv tmp.json reminders.json
                  jq ".[$i].lastSentTime = \"$(date -Iseconds)\"" reminders.json > tmp.json && mv tmp.json reminders.json
                  
                  echo "✅ 下次提醒已更新为: $NEXT_DATE"
                  UPDATED=$((UPDATED+1))
                else
                  echo "❌ Telegram发送失败"
                fi
              else
                echo "⏹️ 今天已发送过提醒，不再重复发送"
              fi
              
              INDEX=$((INDEX+1))
            fi
          done
          
          # 如果有多个到期项目，发送汇总消息
          if [ $SENT -gt 0 ] && [ $INDEX -gt 2 ]; then
            echo ""
            echo "📊 发送汇总消息..."
            
            SUMMARY="╔════════════════════════════╗%0A║  📊 今日到期汇总 %0A╚════════════════════════════╝%0A%0A"
            SUMMARY="${SUMMARY}📊 今日需要处理项目%0A"
            SUMMARY="${SUMMARY}$DUE_ITEMS"
            SUMMARY="${SUMMARY}%0A⚡️ 发送时间 ${{ env.CURRENT_TIME }}"
            
            curl -s -X POST \
              "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              -d "chat_id=${TELEGRAM_CHAT_ID}" \
              -d "text=${SUMMARY}" \
              -d "parse_mode=HTML"
          fi
          
          echo ""
          echo "------------------------"
          echo "📊 本次运行统计:"
          echo "   • 发送提醒: $SENT 条"
          echo "   • 更新日期: $UPDATED 个"
          echo ""
          
          # 提交更新到GitHub
          if [ $UPDATED -gt 0 ]; then
            echo "🔄 自动提交更新到GitHub..."
            
            git config --global user.name "Reminder Bot"
            git config --global user.email "bot@reminder.system"
            
            git add reminders.json
            git commit -m "🤖 自动更新提醒日期 [$(date '+%Y-%m-%d %H:%M')]"
            git push
            
            echo "✅ GitHub更新成功"
          else
            echo "ℹ️ 无需更新"
          fi
          
          echo ""
          echo "========================================="
          echo "✅ 自动执行完成"
          echo "========================================="
