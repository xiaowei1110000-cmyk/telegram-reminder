name: å®šæ—¶æé†’ç³»ç»Ÿ

on:
  schedule:
    - cron: '*/3 * * * *'
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'reminders.json'

jobs:
  reminder:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 1
          
      - name: â° è®¾ç½®åŒ—äº¬æ—¶é—´
        run: |
          sudo timedatectl set-timezone Asia/Shanghai
          echo "TIME=$(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_ENV
          echo "TODAY=$(date '+%Y-%m-%d')" >> $GITHUB_ENV
          
      - name: ğŸ“‹ æ˜¾ç¤ºå½“å‰çŠ¶æ€
        run: |
          echo "========================================="
          echo "ğŸš€ å®šæ—¶æé†’ç³»ç»Ÿå¯åŠ¨"
          echo "â° åŒ—äº¬æ—¶é—´: ${{ env.TIME }}"
          echo "ğŸ“… ä»Šå¤©æ—¥æœŸ: ${{ env.TODAY }}"
          echo "ğŸ“ å·¥ä½œç›®å½•: $(pwd)"
          echo "ğŸ“‚ ä»“åº“: ${{ github.repository }}"
          echo "========================================="
          
          # æ˜¾ç¤ºæé†’æ–‡ä»¶å†…å®¹
          if [ -f "reminders.json" ]; then
            echo "ğŸ“‹ å½“å‰æé†’åˆ—è¡¨:"
            cat reminders.json
            echo ""
          else
            echo "âŒ reminders.json ä¸å­˜åœ¨"
            echo '[]' > reminders.json
          fi
          
      - name: ğŸ” å¼ºåˆ¶æµ‹è¯•æé†’ï¼ˆæ¯æ¬¡éƒ½å‘é€ï¼‰
        id: test
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          echo "ğŸ“¤ å‘é€æµ‹è¯•é€šçŸ¥..."
          
          # å¼ºåˆ¶å‘é€æµ‹è¯•æ¶ˆæ¯
          MESSAGE="ğŸ”” <b>å®šæ—¶æé†’ç³»ç»Ÿæµ‹è¯•</b>%0A%0Aâ° æ—¶é—´: ${{ env.TIME }}%0AğŸ“… ä»Šå¤©: ${{ env.TODAY }}%0AğŸ“¦ ä»“åº“: ${{ github.repository }}%0Aâœ… ç³»ç»Ÿæ­£å¸¸è¿è¡Œ"
          
          RESPONSE=$(curl -s -X POST \
            "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d "chat_id=${TELEGRAM_CHAT_ID}" \
            -d "text=${MESSAGE}" \
            -d "parse_mode=HTML")
          
          if echo "$RESPONSE" | grep -q '"ok":true'; then
            echo "âœ… æµ‹è¯•æ¶ˆæ¯å‘é€æˆåŠŸï¼"
            echo "TEST_RESULT=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ æµ‹è¯•æ¶ˆæ¯å‘é€å¤±è´¥ï¼"
            echo "é”™è¯¯ä¿¡æ¯: $RESPONSE"
            echo "TEST_RESULT=failed" >> $GITHUB_OUTPUT
            exit 1
          fi
          
      - name: ğŸ” æ£€æŸ¥å¹¶å‘é€æé†’
        if: success()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          echo "========================================="
          echo "ğŸ“‹ å¼€å§‹æ£€æŸ¥æé†’..."
          
          # å®‰è£…jq
          sudo apt-get update -qq && sudo apt-get install -y jq -qq
          
          TODAY=$(date '+%Y-%m-%d')
          echo "ğŸ“… ä»Šå¤©: $TODAY"
          
          # è¯»å–æé†’
          COUNT=$(jq '. | length' reminders.json)
          echo "ğŸ“‹ å…±æœ‰ $COUNT ä¸ªæé†’"
          
          SENT=0
          
          for i in $(seq 0 $((COUNT-1))); do
            NAME=$(jq -r ".[$i].name" reminders.json)
            NEXT=$(jq -r ".[$i].nextReminder" reminders.json)
            DAYS=$(jq -r ".[$i].days" reminders.json)
            NOTIFIED=$(jq -r ".[$i].notified // false" reminders.json)
            
            echo "------------------------"
            echo "ğŸ“Œ åç§°: $NAME"
            echo "ğŸ“… ä¸‹æ¬¡: $NEXT"
            echo "â° é—´éš”: $DAYS"
            echo "ğŸ“ å·²é€šçŸ¥: $NOTIFIED"
            
            # å¦‚æœä»Šå¤©åˆ°æœŸ
            if [ "$NEXT" == "$TODAY" ]; then
              echo "âš ï¸ ä»Šæ—¥åˆ°æœŸï¼"
              
              MESSAGE="ğŸ”” <b>å®šæ—¶æé†’</b>%0A%0AğŸ“Œ <b>åç§°ï¼š</b>${NAME}%0AğŸ“… <b>æ—¥æœŸï¼š</b>${TODAY}%0Aâ° <b>é—´éš”ï¼š</b>${DAYS}å¤©%0A%0Aè¯·åŠæ—¶å¤„ç†ï¼"
              
              curl -s -X POST \
                "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
                -d "chat_id=${TELEGRAM_CHAT_ID}" \
                -d "text=${MESSAGE}" \
                -d "parse_mode=HTML"
              
              if [ $? -eq 0 ]; then
                echo "âœ… å‘é€æˆåŠŸ"
                SENT=$((SENT+1))
                
                # æ›´æ–°çŠ¶æ€
                jq ".[$i].notified = true" reminders.json > tmp.json && mv tmp.json reminders.json
                jq ".[$i].lastSentTime = \"$(date -Iseconds)\"" reminders.json > tmp.json && mv tmp.json reminders.json
              fi
            else
              echo "âœ… æœªåˆ°æœŸï¼ˆè¿˜æœ‰ $(( ($(date -d "$NEXT" +%s) - $(date -d "$TODAY" +%s)) / 86400 )) å¤©ï¼‰"
            fi
          done
          
          echo "------------------------"
          echo "ğŸ“Š æœ¬æ¬¡å‘é€: $SENT æ¡"
          
          # æäº¤æ›´æ”¹
          if [ $SENT -gt 0 ]; then
            echo "ğŸ”„ æäº¤æ›´æ–°åˆ°GitHub..."
            
            git config --global user.name "Reminder Bot"
            git config --global user.email "reminder@bot.com"
            
            git add reminders.json
            git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–° [$(date '+%Y-%m-%d %H:%M')]"
            git push
            
            echo "âœ… æ¨é€æˆåŠŸ"
          fi
          
          echo "========================================="
