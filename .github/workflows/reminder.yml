name: Send Telegram Reminder

on:
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: '0 3 * * *'  # æ¯å¤©UTCæ—¶é—´3:00è¿è¡Œï¼ˆåŒ—äº¬æ—¶é—´11:00ï¼‰

jobs:
  send-reminder:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.GH_TOKEN || github.token }}
        
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        
    - name: Read reminders data
      id: read-data
      run: |
        # å°è¯•è¯»å–reminders.jsonæ–‡ä»¶
        if [ -f "reminders.json" ]; then
          echo "æ‰¾åˆ° reminders.json æ–‡ä»¶"
          REMINDERS_COUNT=$(jq length reminders.json)
          echo "æ€»æé†’æ•°é‡: $REMINDERS_COUNT"
          
          # è·å–ä»Šå¤©æ—¥æœŸ
          TODAY=$(date -u +%Y-%m-%d)
          echo "ä»Šå¤©æ—¥æœŸ(UTC): $TODAY"
          
          # æŸ¥æ‰¾ä»Šå¤©åˆ°æœŸçš„æé†’
          DUE_TODAY=$(jq -r --arg today "$TODAY" '[.[] | select(.nextReminder == $today)] | length' reminders.json 2>/dev/null || echo "0")
          echo "ä»Šå¤©åˆ°æœŸæ•°é‡: $DUE_TODAY"
          
          # è®¾ç½®è¾“å‡ºå˜é‡
          echo "reminders_count=$REMINDERS_COUNT" >> $GITHUB_OUTPUT
          echo "due_today=$DUE_TODAY" >> $GITHUB_OUTPUT
          
          # å¦‚æœä»Šå¤©æœ‰åˆ°æœŸçš„æé†’ï¼Œå‡†å¤‡æ¶ˆæ¯
          if [ "$DUE_TODAY" -gt 0 ]; then
            echo "message=ğŸ“… ä»Šæ—¥æé†’é€šçŸ¥" >> $GITHUB_OUTPUT
            echo "has_reminders=true" >> $GITHUB_OUTPUT
          else
            echo "message=ğŸ“… ä»Šå¤©æ²¡æœ‰åˆ°æœŸçš„æé†’" >> $GITHUB_OUTPUT
            echo "has_reminders=false" >> $GITHUB_OUTPUT
          fi
        else
          echo "æœªæ‰¾åˆ° reminders.json æ–‡ä»¶"
          echo "reminders_count=0" >> $GITHUB_OUTPUT
          echo "due_today=0" >> $GITHUB_OUTPUT
          echo "message=â„¹ï¸ æé†’æ•°æ®æ–‡ä»¶ä¸å­˜åœ¨" >> $GITHUB_OUTPUT
          echo "has_reminders=false" >> $GITHUB_OUTPUT
        fi
        
    - name: Send Telegram Notification
      if: steps.read-data.outputs.has_reminders == 'true'
      uses: appleboy/telegram-action@master
      with:
        to: ${{ secrets.TELEGRAM_CHAT_ID }}
        token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        message: |
          ğŸ“… GitHubå®šæ—¶æé†’ç³»ç»Ÿ - ä»Šæ—¥æé†’
          
          æ£€æŸ¥æ—¶é—´ï¼š${{ github.event.schedule || 'æ‰‹åŠ¨è§¦å‘' }}
          æ€»æé†’æ•°é‡ï¼š${{ steps.read-data.outputs.reminders_count }}
          ä»Šæ—¥åˆ°æœŸï¼š${{ steps.read-data.outputs.due_today }}
          
          è¯·ç™»å½•ç³»ç»ŸæŸ¥çœ‹è¯¦æƒ…ï¼š
          https://github.com/${{ github.repository }}
          
          ---
          ğŸ•’ ä¸‹æ¬¡æ£€æŸ¥æ—¶é—´ï¼šåŒ—äº¬æ—¶é—´11:00
          
    - name: Send No Reminders Notification
      if: steps.read-data.outputs.has_reminders == 'false'
      uses: appleboy/telegram-action@master
      with:
        to: ${{ secrets.TELEGRAM_CHAT_ID }}
        token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        message: |
          ğŸ“… GitHubå®šæ—¶æé†’ç³»ç»Ÿ
          
          æ£€æŸ¥æ—¶é—´ï¼š${{ github.event.schedule || 'æ‰‹åŠ¨è§¦å‘' }}
          æ€»æé†’æ•°é‡ï¼š${{ steps.read-data.outputs.reminders_count }}
          ä»Šæ—¥åˆ°æœŸï¼š${{ steps.read-data.outputs.due_today }}
          
          âœ… ä»Šå¤©æ²¡æœ‰éœ€è¦å¤„ç†çš„æé†’ï¼
          
          ---
          ğŸ•’ ä¸‹æ¬¡æ£€æŸ¥æ—¶é—´ï¼šåŒ—äº¬æ—¶é—´11:00
          
    - name: Log reminder status
      run: |
        echo "=== æé†’ç³»ç»ŸçŠ¶æ€ ==="
        echo "è¿è¡Œæ—¶é—´: $(date)"
        echo "ä»“åº“: ${{ github.repository }}"
        echo "è§¦å‘æ–¹å¼: ${{ github.event_name }}"
        echo "æ€»æé†’æ•°é‡: ${{ steps.read-data.outputs.reminders_count }}"
        echo "ä»Šæ—¥åˆ°æœŸ: ${{ steps.read-data.outputs.due_today }}"
        echo "æ¶ˆæ¯: ${{ steps.read-data.outputs.message }}"
